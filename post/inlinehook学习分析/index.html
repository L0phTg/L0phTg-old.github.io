<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>InlineHook学习分析 - L0phTg&#39;s Blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="L0phTg" />
  <meta name="description" content="分析开源的inlineHook代码, 总结inlineHook的原理与实现.

" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.49-DEV" />


<link rel="canonical" href="https://l0phtg.github.io/post/inlinehook%E5%AD%A6%E4%B9%A0%E5%88%86%E6%9E%90/" />



<link rel="icon" href="/favicon.ico" />










<link href="/dist/jane.min.css?v=2.7.0" rel="stylesheet">




<meta property="og:title" content="InlineHook学习分析" />
<meta property="og:description" content="分析开源的inlineHook代码, 总结inlineHook的原理与实现.

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://l0phtg.github.io/post/inlinehook%E5%AD%A6%E4%B9%A0%E5%88%86%E6%9E%90/" /><meta property="article:published_time" content="2018-04-05T02:14:31&#43;08:00"/>
<meta property="article:modified_time" content="2019-04-03T19:59:08&#43;08:00"/>
<meta itemprop="name" content="InlineHook学习分析">
<meta itemprop="description" content="分析开源的inlineHook代码, 总结inlineHook的原理与实现.

">


<meta itemprop="datePublished" content="2018-04-05T02:14:31&#43;08:00" />
<meta itemprop="dateModified" content="2018-04-05T02:14:31&#43;08:00" />
<meta itemprop="wordCount" content="4696">



<meta itemprop="keywords" content="Hook," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="InlineHook学习分析"/>
<meta name="twitter:description" content="分析开源的inlineHook代码, 总结inlineHook的原理与实现.

"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});  // 内联公式
  MathJax.Hub.Config({                                                      // support color
  showProcessingMessages: false,
  jax: ["input/TeX", "output/HTML-CSS"],
  TeX: {
    TagSide: "left",
    Macros: {
      RR: '{\\bf R}',
      bold: ['{\\bf #1}',1]
    }
  }
});
</script>




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">L0phTg&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/about/">About</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://gohugo.io" rel="noopener" target="_blank">
              external-link
              <i class="iconfont icon-new-window"></i>
            </a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      L0phTg's Blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/">Home</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/post/">Archives</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/tags/">Tags</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/categories/">Categories</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/about/">About</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://gohugo.io" rel="noopener" target="_blank">
              external-link
            <i class="iconfont icon-new-window"></i>
            </a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">InlineHook学习分析</h1>
      
      <div class="post-meta">
        <span class="post-time"> 2018-04-05 </span>
        <div class="post-category">
            <a href="https://l0phtg.github.io/categories/hook/"> Hook </a>
            
          </div>
        <span class="more-meta"> 约 4696 字 </span>
          <span class="more-meta"> 预计阅读 10 分钟 </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#前言">前言</a></li>
<li><a href="#参考文章和项目代码">参考文章和项目代码</a></li>
<li><a href="#使用方法">使用方法</a></li>
<li><a href="#分析">分析</a>
<ul>
<li>
<ul>
<li><a href="#使用">使用</a></li>
<li><a href="#registerhook函数">registerHook函数</a>
<ul>
<li><a href="#判断该地址是否是函数地址">判断该地址是否是函数地址</a></li>
<li><a href="#得到hook地址的信息-是否已经hook">得到Hook地址的信息, 是否已经Hook.</a></li>
<li><a href="#得到originlfunaddr的指令类型">得到originlFunAddr的指令类型,</a></li>
<li><a href="#接下来-我们分析最重要的过程">接下来, 我们分析最重要的过程:</a></li>
<li><a href="#下面分析-createcalloriginalstub-hookinfo-info">下面分析 <code>createCallOriginalStub(HookInfo *info)</code>:</a></li>
<li><a href="#msgetinstructionwiththumb">MSGetInstructionWithThumb</a></li>
</ul></li>
<li><a href="#分析memhelper类">分析MemHelper类</a></li>
<li><a href="#分析doinhook">分析doInHook</a></li>
</ul></li>
</ul></li>
<li><a href="#总结">总结</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>分析开源的inlineHook代码, 总结inlineHook的原理与实现.</p>

<p></p>

<p>本文首发于<strong>看雪论坛</strong>, 转载请注明出处.</p>

<h2 id="前言">前言</h2>

<p>最近在面试某大厂的安全岗位时，面试官问到了一些有关hook的知识, 在简单分析了下F8大牛的开源代码之后, 有了这篇文章.</p>

<h2 id="参考文章和项目代码">参考文章和项目代码</h2>

<p>文章:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4">http://ele7enxxh.com/Android-Arm-Inline-Hook.html
http://gslab.qq.com/portal.php?mod=view&amp;aid=168</pre></div>
<p>项目:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4">https://github.com/ele7enxxh/Android-Inline-Hook
https://github.com/F8LEFT/FAInHook</pre></div>
<h2 id="使用方法">使用方法</h2>

<p>MainActivity:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#069;font-weight:bold">static</span> <span style="color:#555">{</span>
        System<span style="color:#555">.</span><span style="color:#309">loadLibrary</span><span style="color:#555">(</span><span style="color:#c30">&#34;FHook&#34;</span><span style="color:#555">);</span>
    <span style="color:#555">}</span>
    
<span style="color:#069;font-weight:bold">public</span> <span style="color:#069;font-weight:bold">native</span> String <span style="color:#c0f">stringFromJNI</span><span style="color:#555">();</span></code></pre></div>
<p>我们会将会测试Hook 这个&rdquo;stringFromJNI()&ldquo;函数.</p>

<h2 id="分析">分析</h2>

<h4 id="使用">使用</h4>

<p>在native层, 我们的main.cpp中</p>

<p>会在JNI_OnLoad中有一个init函数</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">jstring <span style="color:#c0f">stringFromJNI</span><span style="color:#555">(</span>
        JNIEnv <span style="color:#555">*</span>env<span style="color:#555">,</span>
        jobject <span style="color:#555">)</span> <span style="color:#555">{</span>
     doInHook<span style="color:#555">();</span>
    <span style="color:#09f;font-style:italic">// doGotHook();
</span><span style="color:#09f;font-style:italic"></span>    <span style="color:#069;font-weight:bold">return</span> env<span style="color:#555">-&gt;</span>NewStringUTF<span style="color:#555">(</span>getStr<span style="color:#555">());</span>
<span style="color:#555">}</span>

JNIEXPORT jint JNICALL <span style="color:#c0f">JNI_OnLoad</span><span style="color:#555">(</span>JavaVM<span style="color:#555">*</span> vm<span style="color:#555">,</span> <span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>reserved<span style="color:#555">)</span> <span style="color:#555">{</span>
    JNIEnv<span style="color:#555">*</span> env <span style="color:#555">=</span> nullptr<span style="color:#555">;</span>
    jint resultstr <span style="color:#555">=</span> <span style="color:#555">-</span>1<span style="color:#555">;</span>
    <span style="color:#069;font-weight:bold">if</span> <span style="color:#555">(</span>vm<span style="color:#555">-&gt;</span>GetEnv<span style="color:#555">((</span><span style="color:#078;font-weight:bold">void</span> <span style="color:#555">**)</span> <span style="color:#555">&amp;</span>env<span style="color:#555">,</span> JNI_VERSION_1_6<span style="color:#555">)</span> <span style="color:#555">!=</span> JNI_OK<span style="color:#555">)</span> <span style="color:#555">{</span>
        <span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span>1<span style="color:#555">;</span>
    <span style="color:#555">}</span>

    auto jclazz <span style="color:#555">=</span> env<span style="color:#555">-&gt;</span>FindClass<span style="color:#555">(</span><span style="color:#c30">&#34;com/example/l0phtg/hookstudyf8/MainActivity&#34;</span><span style="color:#555">);</span>
    JNINativeMethod natives<span style="color:#555">[]</span> <span style="color:#555">=</span> <span style="color:#555">{</span>
            <span style="color:#555">{</span><span style="color:#c30">&#34;stringFromJNI&#34;</span><span style="color:#555">,</span> <span style="color:#c30">&#34;()Ljava/lang/String;&#34;</span><span style="color:#555">,</span> <span style="color:#555">(</span><span style="color:#078;font-weight:bold">void</span><span style="color:#555">*)</span>stringFromJNI<span style="color:#555">}};</span>
    env<span style="color:#555">-&gt;</span>RegisterNatives<span style="color:#555">(</span>jclazz<span style="color:#555">,</span> natives<span style="color:#555">,</span> 1<span style="color:#555">);</span>
    env<span style="color:#555">-&gt;</span>DeleteLocalRef<span style="color:#555">(</span>jclazz<span style="color:#555">);</span>

    init<span style="color:#555">();</span>

    <span style="color:#069;font-weight:bold">return</span> JNI_VERSION_1_6<span style="color:#555">;</span>
<span style="color:#555">}</span></code></pre></div>
<p>在Hook.cpp我们来看一下init函数:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#078;font-weight:bold">bool</span> <span style="color:#c0f">init</span>() {
    <span style="color:#069;font-weight:bold">auto</span> hook <span style="color:#555">=</span> FAInHook<span style="color:#555">::</span>instance();
    hook<span style="color:#555">-&gt;</span>registerHook((Elf_Addr)getStr,
                       (Elf_Addr)inlCallback,
                       (Elf_Addr<span style="color:#555">*</span>)<span style="color:#555">&amp;</span>inlCallbackSrc);
    <span style="color:#069;font-weight:bold">auto</span> lib <span style="color:#555">=</span> dlopen(<span style="color:#c30">&#34;libFHook.so&#34;</span>, RTLD_NOW);
    gotCallbackSrc <span style="color:#555">=</span> (<span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span><span style="color:#555">*</span> (<span style="color:#555">*</span>)())dlsym(lib, <span style="color:#c30">&#34;_Z6getStrv&#34;</span>);
    dlclose(lib);

    <span style="color:#069;font-weight:bold">return</span> <span style="color:#366">false</span>;
}
</code></pre></div>
<p>可以看到, 我们实例化了一个FAInHook对象, <code>new FAInHook()</code>.</p>

<p>并调用了<code>registerHook</code>函数来注册对getStr的hook.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">FAInHook <span style="color:#555">*</span>FAInHook<span style="color:#555">::</span>instance() {
    <span style="color:#069;font-weight:bold">static</span> FAInHook<span style="color:#555">*</span> mIns <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">nullptr</span>;
    <span style="color:#069;font-weight:bold">if</span>(mIns <span style="color:#555">==</span> <span style="color:#069;font-weight:bold">nullptr</span>) {
        mIns <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> FAInHook();
    }
    <span style="color:#069;font-weight:bold">return</span> mIns;
}
</code></pre></div>
<p>我们在使用是还会用到的<code>doInHook</code>:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4">bool doInHook() {
    static bool isHooked = false;
    if (isHooked) {
        isHooked = false;
        FAInHook::instance()-&gt;unhookAll();
    } else {
        isHooked = true;
        FAInHook::instance()-&gt;hookAll();
    }
    return true;
}</pre></div>
<p><strong>现在可以看到, 我们主要的任务就是分析<code>registerHook</code>和<code>doInHook</code>这两个函数的实现.</strong></p>

<h4 id="registerhook函数">registerHook函数</h4>

<p>我们现在主要分析<code>registerHook</code>函数.</p>

<p>先来分析参数:
在Hook之前我们首先要注册这个函数</p>

<p>函数申明:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4">    HOOK_STATUS registerHook(Elf_Addr orginalFunAddr, Elf_Addr newFunAddr,
                             Elf_Addr* callOrigin);</pre></div>
<p>参数(原始函数地址, 新函数地址, 调用原始函数).</p>

<p>函数主要流程:
1. 注册函数信息, 计算hook stub.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4">首先判断`originFunAddr`和`newFunAddr`是否是函数地址.

auto info = getHookInfo(originFunAddr); 得到函数信息

然后判断函数是否已经被Hook. </pre></div>
<ol>
<li>检查判断指令类型(thumb or arm or x86 &hellip;)</li>
<li>createStub(info)     创建stub, 就是thumb下创建ldr.w pc, [pc],   addr 来执行跳转到newFuncAddr功能</li>
<li>createCallOriginalStub(info) 创建originalFunAddr的stub, 主要会涉及一些对pc相关指令的处理.</li>
</ol>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#09f;font-style:italic">//  register hook
</span><span style="color:#09f;font-style:italic"></span>FAInHook<span style="color:#555">::</span>HOOK_STATUS FAInHook<span style="color:#555">::</span>registerHook(
        Elf_Addr orginalFunAddr, Elf_Addr newFunAddr, Elf_Addr <span style="color:#555">*</span>callOrigin) {
    <span style="color:#09f;font-style:italic">// register hook information, calc hook stub at the same time.
</span><span style="color:#09f;font-style:italic"></span>    <span style="color:#069;font-weight:bold">if</span>(<span style="color:#555">!</span>FAHook<span style="color:#555">::</span>MemHelper<span style="color:#555">::</span>isFunctionAddr((<span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>) orginalFunAddr)
       <span style="color:#555">||</span> <span style="color:#555">!</span>FAHook<span style="color:#555">::</span>MemHelper<span style="color:#555">::</span>isFunctionAddr((<span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>) newFunAddr)) {
        <span style="color:#069;font-weight:bold">return</span> FERROR_NOT_EXECUTABLE;
    }

    <span style="color:#069;font-weight:bold">auto</span> info <span style="color:#555">=</span> getHookInfo(orginalFunAddr);
    <span style="color:#069;font-weight:bold">if</span>(<span style="color:#069;font-weight:bold">nullptr</span> <span style="color:#555">!=</span> info) {
        <span style="color:#069;font-weight:bold">auto</span> hookStatus <span style="color:#555">=</span> info<span style="color:#555">-&gt;</span>getHookStatus();
        <span style="color:#069;font-weight:bold">if</span>(FAHook<span style="color:#555">::</span>HOOKED <span style="color:#555">==</span> hookStatus) {
            <span style="color:#069;font-weight:bold">return</span> FERROR_ALREADY_HOOKED;
        } <span style="color:#069;font-weight:bold">else</span> <span style="color:#069;font-weight:bold">if</span>(FAHook<span style="color:#555">::</span>REGISTERED <span style="color:#555">==</span> hookStatus) {
            delHookInfo(info);
        }
    }

    <span style="color:#09f;font-style:italic">// check for FunctionType
</span><span style="color:#09f;font-style:italic"></span>    <span style="color:#069;font-weight:bold">auto</span> type <span style="color:#555">=</span> FAHook<span style="color:#555">::</span>Instruction<span style="color:#555">::</span>getFunctionType(orginalFunAddr);
    <span style="color:#069;font-weight:bold">if</span>(FAHook<span style="color:#555">::</span>ERRTYPE <span style="color:#555">==</span> type) {
        <span style="color:#069;font-weight:bold">return</span> FERROR_UNKNOWN;
    }

    info <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> FAHook<span style="color:#555">::</span>HookInfo((<span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>) orginalFunAddr, (<span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>) newFunAddr);
    info<span style="color:#555">-&gt;</span>setOriginalFunctionType(type);

    FAHook<span style="color:#555">::</span>Instruction<span style="color:#555">*</span> instruction <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">nullptr</span>;
    <span style="color:#069;font-weight:bold">switch</span>(type) {
<span style="color:#099">#if defined(__arm__)
</span><span style="color:#099"></span>        <span style="color:#069;font-weight:bold">case</span> FAHook<span style="color:#555">::</span><span style="color:#99f">ARM</span>:
            instruction <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> FAHook<span style="color:#555">::</span>ArmInstruction();
            <span style="color:#069;font-weight:bold">break</span>;
        <span style="color:#069;font-weight:bold">case</span> FAHook<span style="color:#555">::</span><span style="color:#99f">THUMB</span>:
            instruction <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> FAHook<span style="color:#555">::</span>ThumbInstruction();
            <span style="color:#069;font-weight:bold">break</span>;
<span style="color:#099">#elif defined(__aarch64__)
</span><span style="color:#099"></span>        <span style="color:#069;font-weight:bold">case</span> FAHook<span style="color:#555">::</span><span style="color:#99f">ARM64</span>:
            instruction <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> FAHook<span style="color:#555">::</span>Arm64Instruction();
            <span style="color:#069;font-weight:bold">break</span>;
<span style="color:#099">#elif defined(__i386__) || defined(__x86_64__)
</span><span style="color:#099"></span>        <span style="color:#069;font-weight:bold">case</span> FAHook<span style="color:#555">::</span><span style="color:#99f">X86</span>:
        <span style="color:#069;font-weight:bold">case</span> FAHook<span style="color:#555">::</span><span style="color:#99f">X64</span>:
            instruction <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> FAHook<span style="color:#555">::</span>IntelInstruction();
            <span style="color:#069;font-weight:bold">break</span>;
<span style="color:#099">#elif defined(__mips64__)
</span><span style="color:#099"></span>            <span style="color:#069;font-weight:bold">case</span> FAHook<span style="color:#555">::</span><span style="color:#99f">MIPS64</span>:
            instruction <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> FAHook<span style="color:#555">::</span>Mips64Instruction();
            <span style="color:#069;font-weight:bold">break</span>;
<span style="color:#099">#elif defined(__mips__)
</span><span style="color:#099"></span>        <span style="color:#069;font-weight:bold">case</span> FAHook<span style="color:#555">::</span><span style="color:#99f">MIPS</span>:
            instruction <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">new</span> FAHook<span style="color:#555">::</span>MipsInstruction();
            <span style="color:#069;font-weight:bold">break</span>;
<span style="color:#099">#endif
</span><span style="color:#099"></span>        <span style="color:#069;font-weight:bold">default</span><span style="color:#555">:</span>
            assert(<span style="color:#366">false</span> <span style="color:#555">&amp;&amp;</span> <span style="color:#c30">&#34;not support abi&#34;</span>);
            <span style="color:#069;font-weight:bold">return</span> FERROR_UNKNOWN;
            <span style="color:#069;font-weight:bold">break</span>;
    }

    <span style="color:#069;font-weight:bold">if</span>(<span style="color:#555">!</span>instruction<span style="color:#555">-&gt;</span>createStub(info)
       <span style="color:#555">||</span> <span style="color:#555">!</span>instruction<span style="color:#555">-&gt;</span>createBackStub(info)
       <span style="color:#555">||</span> (callOrigin <span style="color:#555">!=</span> <span style="color:#069;font-weight:bold">nullptr</span>) <span style="color:#555">?</span>
            <span style="color:#555">!</span>instruction<span style="color:#555">-&gt;</span>createCallOriginalStub(info) <span style="color:#555">:</span> <span style="color:#366">false</span>  <span style="color:#09f;font-style:italic">// want a callback
</span><span style="color:#09f;font-style:italic"></span>       ) {
        <span style="color:#069;font-weight:bold">delete</span> instruction;
        <span style="color:#069;font-weight:bold">delete</span> info;
        <span style="color:#069;font-weight:bold">return</span> FERROR_MEMORY;
    }

    addHookInfo(info);
    info<span style="color:#555">-&gt;</span>setHookStatus(FAHook<span style="color:#555">::</span>REGISTERED);

    <span style="color:#069;font-weight:bold">if</span>(callOrigin <span style="color:#555">!=</span> <span style="color:#069;font-weight:bold">nullptr</span>) {
        <span style="color:#555">*</span>callOrigin <span style="color:#555">=</span> (Elf_Addr) info<span style="color:#555">-&gt;</span>getCallOriginalIns();
    }

    <span style="color:#069;font-weight:bold">delete</span> instruction;
    <span style="color:#069;font-weight:bold">return</span> FERROR_SUCCESS;
}
</code></pre></div>
<h5 id="判断该地址是否是函数地址">判断该地址是否是函数地址</h5>

<ol>
<li>打开<code>/proc/self/maps</code>， 读取每行的信息, 用strstr根据权限做出判断.(r-x, 表示可读可执行, 即为code)()</li>
<li>addr &gt;= startAddr &amp;&amp; addr &lt;= endAddr</li>
</ol>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4">bool FAHook::MemHelper::isFunctionAddr(void *addr) {
    char buf[MAX_BUF];
    auto fp = fopen(maps, &#34;r&#34;);
    if(nullptr == fp) {
        return false;
    }

    while(fgets(buf, MAX_BUF, fp)) {
        if(strstr(buf, &#34;r-xp&#34;) != nullptr) {
            void* startAddr = (void*)strtoul(strtok(buf, &#34;-&#34;), nullptr, 16);
            void* endAddr = (void*)strtoul(strtok(nullptr, &#34; &#34;), nullptr, 16);
            if(addr &gt;= startAddr &amp;&amp; addr &lt;= endAddr) {
                fclose(fp);
                return true;
            }
        }
    }
    fclose(fp);
    FLOGE(this functionAddr is not a function!);
    return false;
}</pre></div>
<h5 id="得到hook地址的信息-是否已经hook">得到Hook地址的信息, 是否已经Hook.</h5>

<p>hook_map是一个std::map<Elf_Addr, FAInHook::HookInfo*>的map类型. find函数会返回返回一个迭代器, 可以用<code>it-&gt;first</code>和<code>it-&gt;second</code>来访问它的成员(key和value). 这个过程其实对已经注册过的hook函数的处理.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4">FAHook::HookInfo *FAInHook::getHookInfo(Elf_Addr origFunAddr) {
    auto it = hook_map.find(origFunAddr);
    if(it == hook_map.end()) {
        return nullptr;
    }
    return it-&gt;second;
}</pre></div>
<h5 id="得到originlfunaddr的指令类型">得到originlFunAddr的指令类型,</h5>

<p>auto type = FAHook::Instruction::getFunctionType(orginalFunAddr);</p>

<p>下面是<code>getFunctionAddr</code>的实现, 可以看到. 判断指令类型的方式, 是通过自己定义宏来实现的. 当然, 在Arm指令中, 我们还要是否该指令为thumb指令.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#069;font-weight:bold">static</span> FunctionType <span style="color:#c0f">getFunctionType</span>(Elf_Addr functionAddr) {
<span style="color:#099">#if defined(__arm__)
</span><span style="color:#099"></span>            <span style="color:#069;font-weight:bold">if</span>(<span style="color:#f60">0</span> <span style="color:#555">==</span> functionAddr) {
                <span style="color:#069;font-weight:bold">return</span> ERRTYPE;
            } <span style="color:#069;font-weight:bold">else</span> <span style="color:#069;font-weight:bold">if</span>((functionAddr <span style="color:#555">&amp;</span> <span style="color:#f60">3</span>) <span style="color:#555">==</span> <span style="color:#f60">0</span>) {
                <span style="color:#069;font-weight:bold">return</span> ARM;
            } <span style="color:#069;font-weight:bold">else</span> {
                <span style="color:#069;font-weight:bold">return</span> THUMB;
            }
<span style="color:#099">#elif defined(__aarch64__)
</span><span style="color:#099"></span>            <span style="color:#069;font-weight:bold">return</span> ARM64;
<span style="color:#099">#elif defined(__i386__)
</span><span style="color:#099"></span>            <span style="color:#069;font-weight:bold">return</span> X86;
<span style="color:#099">#elif defined(__x86_64__)
</span><span style="color:#099"></span>            <span style="color:#069;font-weight:bold">return</span> X64;
<span style="color:#099">#elif defined(__mips64__)  </span><span style="color:#09f;font-style:italic">/* mips64el-* toolchain defines __mips__ too */</span><span style="color:#099">
</span><span style="color:#099"></span>            <span style="color:#069;font-weight:bold">return</span> MIPS64;
<span style="color:#099">#elif defined(__mips__)
</span><span style="color:#099"></span>            <span style="color:#069;font-weight:bold">return</span> MIPS;
<span style="color:#099">#endif
</span><span style="color:#099"></span>        }
</code></pre></div>
<h5 id="接下来-我们分析最重要的过程">接下来, 我们分析最重要的过程:</h5>

<ol>
<li>info = new HookInfo(originFunAddr, newFunAddr);</li>
<li>info.setOriginalFunctionType(type);   设置指令类型为(Arm或者thumb)</li>
<li>instruction = new FAHook::ArmInstruction();        new arm或者thumb指令. 我发现无构造函数.</li>
<li>instruction-&gt;createStub(info);        创建stub.(stub为 jump stub来jump到newFuncAddr)</li>
<li>instruction-&gt;createCallOriginalStub(info)    创建原函数的call back stub.</li>
</ol>

<p>在看<code>HookInfo.h</code>时, 我们可以看到<code>FAHook</code>是一个<code>namespace</code>, 而里面主要包含了一个<code>HookInfo</code>的类:</p>

<p>我们先来分析它的构造函数:</p>

<p>这里运用了c++中的构造函数初始化列表来初始化类成员.</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4">        HookInfo(void* originalAddr, void* hookAddr)
            : original_addr_(originalAddr), hook_addr_(hookAddr),
              original_stub_back_(nullptr), back_len_(0), call_original_ins_(nullptr),
              hook_status_(ERRSTATUS),
              original_function_type_(ERRTYPE), hook_function_type_(ERRTYPE){}
              </pre></div>
<p>分析<code>createStub(info)</code>
我们这里分析<code>FAHook::ThumbInstrution::createStub(FAHook::HookInfo *info)</code>:
1. 将地址按4字节对齐.
2. 保存我们的stub指令, (方便之后path)指令为: <code>LDR.W PC, [PC]</code>. 可参考(<a href="http://ele7enxxh.com/Android-Arm-Inline-Hook.html">http://ele7enxxh.com/Android-Arm-Inline-Hook.html</a>).</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4">bool FAHook::ThumbInstruction::createStub(FAHook::HookInfo *info) {
    auto stubSize = 0;
    uint8_t *stub = nullptr;

    uint32_t addr = (uint32_t)info-&gt;getOriginalAddr();
    auto clearBit0 = addr &amp; 0xFFFFFFFE;

    if (clearBit0 % 4 != 0) {                       // need to align 4, just patch with nop
        stub = new uint8_t[10];
        ((uint16_t*)stub)[stubSize++] = 0xBF00;     //NOP
    } else {
        stub = new uint8_t[8];
    }
    ((uint16_t*)stub)[stubSize++] = 0xF8DF;
    ((uint16_t*)stub)[stubSize++] = 0xF000; // LDR.W PC, [PC]
    ((uint16_t*)stub)[stubSize++] = (uint32_t)info-&gt;getHookAddr() &amp; 0xFFFF;
    ((uint16_t*)stub)[stubSize++] = (uint32_t)info-&gt;getHookAddr() &gt;&gt; 16;

    info-&gt;setJumpStubLen(stubSize * 2);
    info-&gt;setJumpStubBack(stub);
    return true;
}</pre></div>
<h5 id="下面分析-createcalloriginalstub-hookinfo-info">下面分析 <code>createCallOriginalStub(HookInfo *info)</code>:</h5>

<p>thumbInstruction.cpp的实现:</p>

<p>基础知识:</p>

<p>reinterpret_cast<uint16_t*>   为类型转换</p>

<ol>
<li>处理ldr.w指令.</li>
<li>调用createExecMemory(length);              // 分配buffer空间</li>
<li>修正pc相关指令. (ldr liternal.  b.  b.  bl.  cbz. ldrw. add)</li>
</ol>

<p><code>为什么要修正pc相关指令?</code></p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4">举例分析: b &lt;label&gt;:
指令编码分析: [15:12] 1101 [11:8] cond [7:0] imm8
解析时: imm32 = ZeroExtend(imm8:&#39;0&#39;, 32); 
        BranchWritePC(PC+imm32)
可以看到, b指令的指令编码中, 存放的立即数为imm8, 而真实的跳转地址为(pc + imm32).
由于我们是要inlineHook, 所以我们的hook函数执行完成之后还有继续执行我们原来的函数,那么我们就要执行被patch掉的那些指令（我们已经将这些指令保存了下来），但由于存放这些指令的内存是我们mmap出来的,所以我们 要想能够在这里成功运行pc相关指令的话, 我们需要将pc相关的指令转换为其它pc无关的指令。</pre></div>
<p>inlineHook原理图, 来源于gslab.</p>

<p><img src="http://gslab.qq.com/data/attachment/portal/201605/04/165921tz43a3sm4vi2s4s4.png" alt="inlineHook原理图 ---  来源于gslab" /></p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#078;font-weight:bold">bool</span> FAHook<span style="color:#555">::</span>ThumbInstruction<span style="color:#555">::</span>createCallOriginalStub(FAHook<span style="color:#555">::</span>HookInfo <span style="color:#555">*</span>info) {
    uint16_t <span style="color:#555">*</span>area(<span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uint16_t <span style="color:#555">*&gt;</span>(getOriginalAddr(info)));    <span style="color:#09f;font-style:italic">// 起始地址
</span><span style="color:#09f;font-style:italic"></span>

    uint16_t <span style="color:#555">*</span><span style="color:#c0f">trail</span>(<span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uint16_t <span style="color:#555">*&gt;</span>(
                            <span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uintptr_t <span style="color:#555">&gt;</span>(area) <span style="color:#555">+</span> info<span style="color:#555">-&gt;</span>getJumpStubLen())); <span style="color:#09f;font-style:italic">// 结束地址
</span><span style="color:#09f;font-style:italic"></span>
    <span style="color:#069;font-weight:bold">if</span>(T<span style="color:#a00;background-color:#faa">$</span>pcrel<span style="color:#a00;background-color:#faa">$</span>ldrw(area[<span style="color:#f60">0</span>]) <span style="color:#555">&amp;&amp;</span>  <span style="color:#09f;font-style:italic">// 第一条指令
</span><span style="color:#09f;font-style:italic"></span>        area[<span style="color:#f60">1</span>] <span style="color:#555">==</span> <span style="color:#f60">0xF000</span>   <span style="color:#09f;font-style:italic">// 判断第一条指令是否为 ldr pc, [pc]  
</span><span style="color:#09f;font-style:italic"></span>            ) {
        uint32_t <span style="color:#555">*</span>arm(<span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uint32_t <span style="color:#555">*&gt;</span>(area));
        info<span style="color:#555">-&gt;</span>setCallOriginalIns(<span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uint8_t <span style="color:#555">*&gt;</span>(arm[<span style="color:#f60">1</span>]));
        <span style="color:#069;font-weight:bold">return</span> <span style="color:#366">true</span>;
    }

    size_t required((trail <span style="color:#555">-</span> area) <span style="color:#555">*</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t)); <span style="color:#09f;font-style:italic">// required == 需要patch多少字节
</span><span style="color:#09f;font-style:italic"></span>
    size_t <span style="color:#c0f">used</span>(<span style="color:#f60">0</span>);
    <span style="color:#069;font-weight:bold">while</span> (used <span style="color:#555">&lt;</span> required)
        used <span style="color:#555">+=</span> MSGetInstructionWidthThumb(<span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uint8_t <span style="color:#555">*&gt;</span>(area) <span style="color:#555">+</span> used);
    used <span style="color:#555">=</span> (used <span style="color:#555">+</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t) <span style="color:#555">-</span> <span style="color:#f60">1</span>) <span style="color:#555">/</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t) <span style="color:#555">*</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t);

    size_t <span style="color:#c0f">blank</span>((used <span style="color:#555">-</span> required) <span style="color:#555">/</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t));

    uint16_t backup[used <span style="color:#555">/</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t)];
    memcpy(backup, area, used);


    size_t <span style="color:#c0f">length</span>(used);
    <span style="color:#069;font-weight:bold">for</span> (<span style="color:#078;font-weight:bold">unsigned</span> offset(<span style="color:#f60">0</span>); offset <span style="color:#555">!=</span> used <span style="color:#555">/</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t); <span style="color:#555">++</span>offset)
        <span style="color:#069;font-weight:bold">if</span> (T<span style="color:#a00;background-color:#faa">$</span>pcrel<span style="color:#a00;background-color:#faa">$</span>ldr(backup[offset]))
            length <span style="color:#555">+=</span> <span style="color:#f60">3</span> <span style="color:#555">*</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t);
        <span style="color:#069;font-weight:bold">else</span> <span style="color:#c0f">if</span> (T<span style="color:#a00;background-color:#faa">$</span>pcrel<span style="color:#a00;background-color:#faa">$</span>b(backup[offset]))
            length <span style="color:#555">+=</span> <span style="color:#f60">6</span> <span style="color:#555">*</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t);
        <span style="color:#069;font-weight:bold">else</span> <span style="color:#c0f">if</span> (T2<span style="color:#a00;background-color:#faa">$</span>pcrel<span style="color:#a00;background-color:#faa">$</span>b(backup <span style="color:#555">+</span> offset)) {
            length <span style="color:#555">+=</span> <span style="color:#f60">5</span> <span style="color:#555">*</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t);
            <span style="color:#555">++</span>offset;
        } <span style="color:#069;font-weight:bold">else</span> <span style="color:#c0f">if</span> (T<span style="color:#a00;background-color:#faa">$</span>pcrel<span style="color:#a00;background-color:#faa">$</span>bl(backup <span style="color:#555">+</span> offset)) {
            length <span style="color:#555">+=</span> <span style="color:#f60">5</span> <span style="color:#555">*</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t);
            <span style="color:#555">++</span>offset;
        } <span style="color:#069;font-weight:bold">else</span> <span style="color:#c0f">if</span> (T<span style="color:#a00;background-color:#faa">$</span>pcrel<span style="color:#a00;background-color:#faa">$</span>cbz(backup[offset])) {
            length <span style="color:#555">+=</span> <span style="color:#f60">16</span> <span style="color:#555">*</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t);
        } <span style="color:#069;font-weight:bold">else</span> <span style="color:#c0f">if</span> (T<span style="color:#a00;background-color:#faa">$</span>pcrel<span style="color:#a00;background-color:#faa">$</span>ldrw(backup[offset])) {
            length <span style="color:#555">+=</span> <span style="color:#f60">4</span> <span style="color:#555">*</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t);
            <span style="color:#555">++</span>offset;
        } <span style="color:#069;font-weight:bold">else</span> <span style="color:#c0f">if</span> (T<span style="color:#a00;background-color:#faa">$</span>pcrel<span style="color:#a00;background-color:#faa">$</span>add(backup[offset]))
            length <span style="color:#555">+=</span> <span style="color:#f60">6</span> <span style="color:#555">*</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t);
        <span style="color:#069;font-weight:bold">else</span> <span style="color:#c0f">if</span> (T<span style="color:#a00;background-color:#faa">$</span><span style="color:#f60">32</span>bit<span style="color:#a00;background-color:#faa">$</span>i(backup[offset]))
            <span style="color:#555">++</span>offset;

        <span style="color:#078;font-weight:bold">unsigned</span> <span style="color:#c0f">pad</span>((length <span style="color:#555">&amp;</span> <span style="color:#f60">0x2</span>) <span style="color:#555">==</span> <span style="color:#f60">0</span> <span style="color:#555">?</span> <span style="color:#f60">0</span> <span style="color:#555">:</span> <span style="color:#f60">1</span>);
        length <span style="color:#555">+=</span> (pad <span style="color:#555">+</span> <span style="color:#f60">2</span>) <span style="color:#555">*</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t) <span style="color:#555">+</span> <span style="color:#f60">2</span> <span style="color:#555">*</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint32_t);

    uint16_t <span style="color:#555">*</span>buffer <span style="color:#555">=</span> (uint16_t <span style="color:#555">*</span>) MemHelper<span style="color:#555">::</span>createExecMemory(length);
    <span style="color:#069;font-weight:bold">if</span>(buffer <span style="color:#555">==</span> <span style="color:#069;font-weight:bold">nullptr</span>) {
        <span style="color:#069;font-weight:bold">return</span> <span style="color:#366">false</span>;
    }

    size_t start(pad), end(length <span style="color:#555">/</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t));
    uint32_t <span style="color:#555">*</span><span style="color:#c0f">trailer</span>(<span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uint32_t <span style="color:#555">*&gt;</span>(buffer <span style="color:#555">+</span> end));
    <span style="color:#069;font-weight:bold">for</span> (<span style="color:#078;font-weight:bold">unsigned</span> offset(<span style="color:#f60">0</span>); offset <span style="color:#555">!=</span> used <span style="color:#555">/</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t); <span style="color:#555">++</span>offset) {
        <span style="color:#069;font-weight:bold">if</span> (T<span style="color:#a00;background-color:#faa">$</span>pcrel<span style="color:#a00;background-color:#faa">$</span>ldr(backup[offset])) {
            <span style="color:#069;font-weight:bold">union</span> {
                uint16_t value;

                <span style="color:#069;font-weight:bold">struct</span> {
                    uint16_t <span style="color:#99f">immediate</span> : <span style="color:#f60">8</span>;
                    uint16_t <span style="color:#99f">rd</span> : <span style="color:#f60">3</span>;
                    <span style="color:#99f">uint16_t</span> : <span style="color:#f60">5</span>;
                };
            } bits <span style="color:#555">=</span> {backup[offset<span style="color:#555">+</span><span style="color:#f60">0</span>]};

            buffer[start<span style="color:#555">+</span><span style="color:#f60">0</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>ldr_rd_<span style="color:#a00;background-color:#faa">$</span>pc_im_4<span style="color:#a00;background-color:#faa">$</span>(bits.rd, T<span style="color:#a00;background-color:#faa">$</span>Label(start<span style="color:#555">+</span><span style="color:#f60">0</span>, end<span style="color:#555">-</span><span style="color:#f60">2</span>) <span style="color:#555">/</span> <span style="color:#f60">4</span>);
            buffer[start<span style="color:#555">+</span><span style="color:#f60">1</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>ldr_rd_<span style="color:#a00;background-color:#faa">$</span>rn_im_4<span style="color:#a00;background-color:#faa">$</span>(bits.rd, bits.rd, <span style="color:#f60">0</span>);

            <span style="color:#09f;font-style:italic">// XXX: this code &#34;works&#34;, but is &#34;wrong&#34;: the mechanism is more complex than this
</span><span style="color:#09f;font-style:italic"></span>            <span style="color:#555">*--</span>trailer <span style="color:#555">=</span> ((<span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uint32_t<span style="color:#555">&gt;</span>(area <span style="color:#555">+</span> offset) <span style="color:#555">+</span> <span style="color:#f60">4</span>) <span style="color:#555">&amp;</span> <span style="color:#555">~</span><span style="color:#f60">0x2</span>) <span style="color:#555">+</span> bits.immediate <span style="color:#555">*</span> <span style="color:#f60">4</span>;

            start <span style="color:#555">+=</span> <span style="color:#f60">2</span>;
            end <span style="color:#555">-=</span> <span style="color:#f60">2</span>;
        } <span style="color:#069;font-weight:bold">else</span> <span style="color:#069;font-weight:bold">if</span> (T<span style="color:#a00;background-color:#faa">$</span>pcrel<span style="color:#a00;background-color:#faa">$</span>b(backup[offset])) {
            <span style="color:#069;font-weight:bold">union</span> {
                uint16_t value;

                <span style="color:#069;font-weight:bold">struct</span> {
                    uint16_t <span style="color:#99f">imm8</span> : <span style="color:#f60">8</span>;
                    uint16_t <span style="color:#99f">cond</span> : <span style="color:#f60">4</span>;
                    uint16_t <span style="color:#09f;font-style:italic">/*1101*/</span> <span style="color:#555">:</span> <span style="color:#f60">4</span>;
                };
            } bits <span style="color:#555">=</span> {backup[offset<span style="color:#555">+</span><span style="color:#f60">0</span>]};

            intptr_t <span style="color:#c0f">jump</span>(bits.imm8 <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">1</span>);
            jump <span style="color:#555">|=</span> <span style="color:#f60">1</span>;
            jump <span style="color:#555">&lt;&lt;=</span> <span style="color:#f60">23</span>;
            jump <span style="color:#555">&gt;&gt;=</span> <span style="color:#f60">23</span>;

            buffer[start<span style="color:#555">+</span><span style="color:#f60">0</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>b<span style="color:#a00;background-color:#faa">$</span>_<span style="color:#a00;background-color:#faa">$</span>im(bits.cond, (end<span style="color:#555">-</span><span style="color:#f60">6</span> <span style="color:#555">-</span> (start<span style="color:#555">+</span><span style="color:#f60">0</span>)) <span style="color:#555">*</span> <span style="color:#f60">2</span> <span style="color:#555">-</span> <span style="color:#f60">4</span>);

            <span style="color:#555">*--</span>trailer <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uint32_t<span style="color:#555">&gt;</span>(area <span style="color:#555">+</span> offset) <span style="color:#555">+</span> <span style="color:#f60">4</span> <span style="color:#555">+</span> jump;
            <span style="color:#555">*--</span>trailer <span style="color:#555">=</span> A<span style="color:#a00;background-color:#faa">$</span>ldr_rd_<span style="color:#a00;background-color:#faa">$</span>rn_im<span style="color:#a00;background-color:#faa">$</span>(A<span style="color:#a00;background-color:#faa">$</span>pc, A<span style="color:#a00;background-color:#faa">$</span>pc, <span style="color:#f60">4</span> <span style="color:#555">-</span> <span style="color:#f60">8</span>);
            <span style="color:#555">*--</span>trailer <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>nop <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">16</span> <span style="color:#555">|</span> T<span style="color:#a00;background-color:#faa">$</span>bx(A<span style="color:#a00;background-color:#faa">$</span>pc);

            start <span style="color:#555">+=</span> <span style="color:#f60">1</span>;
            end <span style="color:#555">-=</span> <span style="color:#f60">6</span>;
        } <span style="color:#069;font-weight:bold">else</span> <span style="color:#069;font-weight:bold">if</span> (T2<span style="color:#a00;background-color:#faa">$</span>pcrel<span style="color:#a00;background-color:#faa">$</span>b(backup <span style="color:#555">+</span> offset)) {
            <span style="color:#069;font-weight:bold">union</span> {
                uint16_t value;

                <span style="color:#069;font-weight:bold">struct</span> {
                    uint16_t <span style="color:#99f">imm6</span> : <span style="color:#f60">6</span>;
                    uint16_t <span style="color:#99f">cond</span> : <span style="color:#f60">4</span>;
                    uint16_t <span style="color:#99f">s</span> : <span style="color:#f60">1</span>;
                    <span style="color:#99f">uint16_t</span> : <span style="color:#f60">5</span>;
                };
            } bits <span style="color:#555">=</span> {backup[offset<span style="color:#555">+</span><span style="color:#f60">0</span>]};

            <span style="color:#069;font-weight:bold">union</span> {
                uint16_t value;

                <span style="color:#069;font-weight:bold">struct</span> {
                    uint16_t <span style="color:#99f">imm11</span> : <span style="color:#f60">11</span>;
                    uint16_t <span style="color:#99f">j2</span> : <span style="color:#f60">1</span>;
                    uint16_t <span style="color:#99f">a</span> : <span style="color:#f60">1</span>;
                    uint16_t <span style="color:#99f">j1</span> : <span style="color:#f60">1</span>;
                    <span style="color:#99f">uint16_t</span> : <span style="color:#f60">2</span>;
                };
            } exts <span style="color:#555">=</span> {backup[offset<span style="color:#555">+</span><span style="color:#f60">1</span>]};

            intptr_t <span style="color:#c0f">jump</span>(<span style="color:#f60">1</span>);
            jump <span style="color:#555">|=</span> exts.imm11 <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">1</span>;
            jump <span style="color:#555">|=</span> bits.imm6 <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">12</span>;

            <span style="color:#069;font-weight:bold">if</span> (exts.a) {
                jump <span style="color:#555">|=</span> bits.s <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">24</span>;
                jump <span style="color:#555">|=</span> (<span style="color:#555">~</span>(bits.s <span style="color:#555">^</span> exts.j1) <span style="color:#555">&amp;</span> <span style="color:#f60">0x1</span>) <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">23</span>;
                jump <span style="color:#555">|=</span> (<span style="color:#555">~</span>(bits.s <span style="color:#555">^</span> exts.j2) <span style="color:#555">&amp;</span> <span style="color:#f60">0x1</span>) <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">22</span>;
                jump <span style="color:#555">|=</span> bits.cond <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">18</span>;
                jump <span style="color:#555">&lt;&lt;=</span> <span style="color:#f60">7</span>;
                jump <span style="color:#555">&gt;&gt;=</span> <span style="color:#f60">7</span>;
            } <span style="color:#069;font-weight:bold">else</span> {
                jump <span style="color:#555">|=</span> bits.s <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">20</span>;
                jump <span style="color:#555">|=</span> exts.j2 <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">19</span>;
                jump <span style="color:#555">|=</span> exts.j1 <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">18</span>;
                jump <span style="color:#555">&lt;&lt;=</span> <span style="color:#f60">11</span>;
                jump <span style="color:#555">&gt;&gt;=</span> <span style="color:#f60">11</span>;
            }

            buffer[start<span style="color:#555">+</span><span style="color:#f60">0</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>b<span style="color:#a00;background-color:#faa">$</span>_<span style="color:#a00;background-color:#faa">$</span>im(exts.a <span style="color:#555">?</span> A<span style="color:#a00;background-color:#faa">$</span><span style="color:#99f">al</span> : bits.cond, (end<span style="color:#555">-</span><span style="color:#f60">6</span> <span style="color:#555">-</span> (start<span style="color:#555">+</span><span style="color:#f60">0</span>)) <span style="color:#555">*</span> <span style="color:#f60">2</span> <span style="color:#555">-</span> <span style="color:#f60">4</span>);

            <span style="color:#555">*--</span>trailer <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uint32_t<span style="color:#555">&gt;</span>(area <span style="color:#555">+</span> offset) <span style="color:#555">+</span> <span style="color:#f60">4</span> <span style="color:#555">+</span> jump;
            <span style="color:#555">*--</span>trailer <span style="color:#555">=</span> A<span style="color:#a00;background-color:#faa">$</span>ldr_rd_<span style="color:#a00;background-color:#faa">$</span>rn_im<span style="color:#a00;background-color:#faa">$</span>(A<span style="color:#a00;background-color:#faa">$</span>pc, A<span style="color:#a00;background-color:#faa">$</span>pc, <span style="color:#f60">4</span> <span style="color:#555">-</span> <span style="color:#f60">8</span>);
            <span style="color:#555">*--</span>trailer <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>nop <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">16</span> <span style="color:#555">|</span> T<span style="color:#a00;background-color:#faa">$</span>bx(A<span style="color:#a00;background-color:#faa">$</span>pc);

            <span style="color:#555">++</span>offset;
            start <span style="color:#555">+=</span> <span style="color:#f60">1</span>;
            end <span style="color:#555">-=</span> <span style="color:#f60">6</span>;
        } <span style="color:#069;font-weight:bold">else</span> <span style="color:#069;font-weight:bold">if</span> (T<span style="color:#a00;background-color:#faa">$</span>pcrel<span style="color:#a00;background-color:#faa">$</span>bl(backup <span style="color:#555">+</span> offset)) {
            <span style="color:#069;font-weight:bold">union</span> {
                uint16_t value;

                <span style="color:#069;font-weight:bold">struct</span> {
                    uint16_t <span style="color:#99f">immediate</span> : <span style="color:#f60">10</span>;
                    uint16_t <span style="color:#99f">s</span> : <span style="color:#f60">1</span>;
                    <span style="color:#99f">uint16_t</span> : <span style="color:#f60">5</span>;
                };
            } bits <span style="color:#555">=</span> {backup[offset<span style="color:#555">+</span><span style="color:#f60">0</span>]};

            <span style="color:#069;font-weight:bold">union</span> {
                uint16_t value;

                <span style="color:#069;font-weight:bold">struct</span> {
                    uint16_t <span style="color:#99f">immediate</span> : <span style="color:#f60">11</span>;
                    uint16_t <span style="color:#99f">j2</span> : <span style="color:#f60">1</span>;
                    uint16_t <span style="color:#99f">x</span> : <span style="color:#f60">1</span>;
                    uint16_t <span style="color:#99f">j1</span> : <span style="color:#f60">1</span>;
                    <span style="color:#99f">uint16_t</span> : <span style="color:#f60">2</span>;
                };
            } exts <span style="color:#555">=</span> {backup[offset<span style="color:#555">+</span><span style="color:#f60">1</span>]};

            int32_t <span style="color:#c0f">jump</span>(<span style="color:#f60">0</span>);
            jump <span style="color:#555">|=</span> bits.s <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">24</span>;
            jump <span style="color:#555">|=</span> (<span style="color:#555">~</span>(bits.s <span style="color:#555">^</span> exts.j1) <span style="color:#555">&amp;</span> <span style="color:#f60">0x1</span>) <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">23</span>;
            jump <span style="color:#555">|=</span> (<span style="color:#555">~</span>(bits.s <span style="color:#555">^</span> exts.j2) <span style="color:#555">&amp;</span> <span style="color:#f60">0x1</span>) <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">22</span>;
            jump <span style="color:#555">|=</span> bits.immediate <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">12</span>;
            jump <span style="color:#555">|=</span> exts.immediate <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">1</span>;
            jump <span style="color:#555">|=</span> exts.x;
            jump <span style="color:#555">&lt;&lt;=</span> <span style="color:#f60">7</span>;
            jump <span style="color:#555">&gt;&gt;=</span> <span style="color:#f60">7</span>;

            buffer[start<span style="color:#555">+</span><span style="color:#f60">0</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>push_r(<span style="color:#f60">1</span> <span style="color:#555">&lt;&lt;</span> A<span style="color:#a00;background-color:#faa">$</span>r7);
            buffer[start<span style="color:#555">+</span><span style="color:#f60">1</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>ldr_rd_<span style="color:#a00;background-color:#faa">$</span>pc_im_4<span style="color:#a00;background-color:#faa">$</span>(A<span style="color:#a00;background-color:#faa">$</span>r7, ((end<span style="color:#555">-</span><span style="color:#f60">2</span> <span style="color:#555">-</span> (start<span style="color:#555">+</span><span style="color:#f60">1</span>)) <span style="color:#555">*</span> <span style="color:#f60">2</span> <span style="color:#555">-</span> <span style="color:#f60">4</span> <span style="color:#555">+</span> <span style="color:#f60">2</span>) <span style="color:#555">/</span> <span style="color:#f60">4</span>);
            buffer[start<span style="color:#555">+</span><span style="color:#f60">2</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>mov_rd_rm(A<span style="color:#a00;background-color:#faa">$</span>lr, A<span style="color:#a00;background-color:#faa">$</span>r7);
            buffer[start<span style="color:#555">+</span><span style="color:#f60">3</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>pop_r(<span style="color:#f60">1</span> <span style="color:#555">&lt;&lt;</span> A<span style="color:#a00;background-color:#faa">$</span>r7);
            buffer[start<span style="color:#555">+</span><span style="color:#f60">4</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>blx(A<span style="color:#a00;background-color:#faa">$</span>lr);

            <span style="color:#555">*--</span>trailer <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uint32_t<span style="color:#555">&gt;</span>(area <span style="color:#555">+</span> offset) <span style="color:#555">+</span> <span style="color:#f60">4</span> <span style="color:#555">+</span> jump;

            <span style="color:#555">++</span>offset;
            start <span style="color:#555">+=</span> <span style="color:#f60">5</span>;
            end <span style="color:#555">-=</span> <span style="color:#f60">2</span>;
        } <span style="color:#069;font-weight:bold">else</span> <span style="color:#069;font-weight:bold">if</span> (T<span style="color:#a00;background-color:#faa">$</span>pcrel<span style="color:#a00;background-color:#faa">$</span>cbz(backup[offset])) {
            <span style="color:#069;font-weight:bold">union</span> {
                uint16_t value;

                <span style="color:#069;font-weight:bold">struct</span> {
                    uint16_t <span style="color:#99f">rn</span> : <span style="color:#f60">3</span>;
                    uint16_t <span style="color:#99f">immediate</span> : <span style="color:#f60">5</span>;
                    <span style="color:#99f">uint16_t</span> : <span style="color:#f60">1</span>;
                    uint16_t <span style="color:#99f">i</span> : <span style="color:#f60">1</span>;
                    <span style="color:#99f">uint16_t</span> : <span style="color:#f60">1</span>;
                    uint16_t <span style="color:#99f">op</span> : <span style="color:#f60">1</span>;
                    <span style="color:#99f">uint16_t</span> : <span style="color:#f60">4</span>;
                };
            } bits <span style="color:#555">=</span> {backup[offset<span style="color:#555">+</span><span style="color:#f60">0</span>]};

            intptr_t <span style="color:#c0f">jump</span>(<span style="color:#f60">1</span>);
            jump <span style="color:#555">|=</span> bits.i <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">6</span>;
            jump <span style="color:#555">|=</span> bits.immediate <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">1</span>;

            <span style="color:#09f;font-style:italic">//jump &lt;&lt;= 24;
</span><span style="color:#09f;font-style:italic"></span>            <span style="color:#09f;font-style:italic">//jump &gt;&gt;= 24;
</span><span style="color:#09f;font-style:italic"></span>
            <span style="color:#078;font-weight:bold">unsigned</span> <span style="color:#c0f">rn</span>(bits.rn);
            <span style="color:#078;font-weight:bold">unsigned</span> <span style="color:#c0f">rt</span>(rn <span style="color:#555">==</span> A<span style="color:#a00;background-color:#faa">$</span>r7 <span style="color:#555">?</span> A<span style="color:#a00;background-color:#faa">$</span><span style="color:#99f">r6</span> : A<span style="color:#a00;background-color:#faa">$</span>r7);

            buffer[start<span style="color:#555">+</span><span style="color:#f60">0</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>push_r(<span style="color:#f60">1</span> <span style="color:#555">&lt;&lt;</span> rt);
            buffer[start<span style="color:#555">+</span><span style="color:#f60">1</span>] <span style="color:#555">=</span> T1<span style="color:#a00;background-color:#faa">$</span>mrs_rd_apsr(rt);
            buffer[start<span style="color:#555">+</span><span style="color:#f60">2</span>] <span style="color:#555">=</span> T2<span style="color:#a00;background-color:#faa">$</span>mrs_rd_apsr(rt);
            buffer[start<span style="color:#555">+</span><span style="color:#f60">3</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>cbz<span style="color:#a00;background-color:#faa">$</span>_rn_<span style="color:#a00;background-color:#faa">$</span>im(bits.op, rn, (end<span style="color:#555">-</span><span style="color:#f60">10</span> <span style="color:#555">-</span> (start<span style="color:#555">+</span><span style="color:#f60">3</span>)) <span style="color:#555">*</span> <span style="color:#f60">2</span> <span style="color:#555">-</span> <span style="color:#f60">4</span>);
            buffer[start<span style="color:#555">+</span><span style="color:#f60">4</span>] <span style="color:#555">=</span> T1<span style="color:#a00;background-color:#faa">$</span>msr_apsr_nzcvqg_rn(rt);
            buffer[start<span style="color:#555">+</span><span style="color:#f60">5</span>] <span style="color:#555">=</span> T2<span style="color:#a00;background-color:#faa">$</span>msr_apsr_nzcvqg_rn(rt);
            buffer[start<span style="color:#555">+</span><span style="color:#f60">6</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>pop_r(<span style="color:#f60">1</span> <span style="color:#555">&lt;&lt;</span> rt);

            <span style="color:#555">*--</span>trailer <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uint32_t<span style="color:#555">&gt;</span>(area <span style="color:#555">+</span> offset) <span style="color:#555">+</span> <span style="color:#f60">4</span> <span style="color:#555">+</span> jump;
            <span style="color:#555">*--</span>trailer <span style="color:#555">=</span> A<span style="color:#a00;background-color:#faa">$</span>ldr_rd_<span style="color:#a00;background-color:#faa">$</span>rn_im<span style="color:#a00;background-color:#faa">$</span>(A<span style="color:#a00;background-color:#faa">$</span>pc, A<span style="color:#a00;background-color:#faa">$</span>pc, <span style="color:#f60">4</span> <span style="color:#555">-</span> <span style="color:#f60">8</span>);
            <span style="color:#555">*--</span>trailer <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>nop <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">16</span> <span style="color:#555">|</span> T<span style="color:#a00;background-color:#faa">$</span>bx(A<span style="color:#a00;background-color:#faa">$</span>pc);
            <span style="color:#555">*--</span>trailer <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>nop <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">16</span> <span style="color:#555">|</span> T<span style="color:#a00;background-color:#faa">$</span>pop_r(<span style="color:#f60">1</span> <span style="color:#555">&lt;&lt;</span> rt);
            <span style="color:#555">*--</span>trailer <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>msr_apsr_nzcvqg_rn(rt);

<span style="color:#099">#if 0</span><span style="color:#09f;font-style:italic">
</span><span style="color:#09f;font-style:italic">            if ((start &amp; 0x1) == 0)
</span><span style="color:#09f;font-style:italic">                buffer[start++] = T$nop;
</span><span style="color:#09f;font-style:italic">            buffer[start++] = T$bx(A$pc);
</span><span style="color:#09f;font-style:italic">            buffer[start++] = T$nop;
</span><span style="color:#09f;font-style:italic">
</span><span style="color:#09f;font-style:italic">            uint32_t *arm(reinterpret_cast&lt;uint32_t *&gt;(buffer + start));
</span><span style="color:#09f;font-style:italic">            arm[0] = A$add(A$lr, A$pc, 1);
</span><span style="color:#09f;font-style:italic">            arm[1] = A$ldr_rd_$rn_im$(A$pc, A$pc, (trailer - arm) * sizeof(uint32_t) - 8);
</span><span style="color:#09f;font-style:italic"></span><span style="color:#099">#endif
</span><span style="color:#099"></span>
            start <span style="color:#555">+=</span> <span style="color:#f60">7</span>;
            end <span style="color:#555">-=</span> <span style="color:#f60">10</span>;
        } <span style="color:#069;font-weight:bold">else</span> <span style="color:#069;font-weight:bold">if</span> (T<span style="color:#a00;background-color:#faa">$</span>pcrel<span style="color:#a00;background-color:#faa">$</span>ldrw(backup[offset])) {
            <span style="color:#069;font-weight:bold">union</span> {
                uint16_t value;

                <span style="color:#069;font-weight:bold">struct</span> {
                    <span style="color:#99f">uint16_t</span> : <span style="color:#f60">7</span>;
                    uint16_t <span style="color:#99f">u</span> : <span style="color:#f60">1</span>;
                    <span style="color:#99f">uint16_t</span> : <span style="color:#f60">8</span>;
                };
            } bits <span style="color:#555">=</span> {backup[offset<span style="color:#555">+</span><span style="color:#f60">0</span>]};

            <span style="color:#069;font-weight:bold">union</span> {
                uint16_t value;

                <span style="color:#069;font-weight:bold">struct</span> {
                    uint16_t <span style="color:#99f">immediate</span> : <span style="color:#f60">12</span>;
                    uint16_t <span style="color:#99f">rt</span> : <span style="color:#f60">4</span>;
                };
            } exts <span style="color:#555">=</span> {backup[offset<span style="color:#555">+</span><span style="color:#f60">1</span>]};

            buffer[start<span style="color:#555">+</span><span style="color:#f60">0</span>] <span style="color:#555">=</span> T1<span style="color:#a00;background-color:#faa">$</span>ldr_rt_<span style="color:#a00;background-color:#faa">$</span>rn_im<span style="color:#a00;background-color:#faa">$</span>(exts.rt, A<span style="color:#a00;background-color:#faa">$</span>pc, T<span style="color:#a00;background-color:#faa">$</span>Label(start<span style="color:#555">+</span><span style="color:#f60">0</span>, end<span style="color:#555">-</span><span style="color:#f60">2</span>));
            buffer[start<span style="color:#555">+</span><span style="color:#f60">1</span>] <span style="color:#555">=</span> T2<span style="color:#a00;background-color:#faa">$</span>ldr_rt_<span style="color:#a00;background-color:#faa">$</span>rn_im<span style="color:#a00;background-color:#faa">$</span>(exts.rt, A<span style="color:#a00;background-color:#faa">$</span>pc, T<span style="color:#a00;background-color:#faa">$</span>Label(start<span style="color:#555">+</span><span style="color:#f60">0</span>, end<span style="color:#555">-</span><span style="color:#f60">2</span>));

            buffer[start<span style="color:#555">+</span><span style="color:#f60">2</span>] <span style="color:#555">=</span> T1<span style="color:#a00;background-color:#faa">$</span>ldr_rt_<span style="color:#a00;background-color:#faa">$</span>rn_im<span style="color:#a00;background-color:#faa">$</span>(exts.rt, exts.rt, <span style="color:#f60">0</span>);
            buffer[start<span style="color:#555">+</span><span style="color:#f60">3</span>] <span style="color:#555">=</span> T2<span style="color:#a00;background-color:#faa">$</span>ldr_rt_<span style="color:#a00;background-color:#faa">$</span>rn_im<span style="color:#a00;background-color:#faa">$</span>(exts.rt, exts.rt, <span style="color:#f60">0</span>);

            <span style="color:#09f;font-style:italic">// XXX: this code &#34;works&#34;, but is &#34;wrong&#34;: the mechanism is more complex than this
</span><span style="color:#09f;font-style:italic"></span>            <span style="color:#555">*--</span>trailer <span style="color:#555">=</span> ((<span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uint32_t<span style="color:#555">&gt;</span>(area <span style="color:#555">+</span> offset) <span style="color:#555">+</span> <span style="color:#f60">4</span>) <span style="color:#555">&amp;</span> <span style="color:#555">~</span><span style="color:#f60">0x2</span>) <span style="color:#555">+</span> (bits.u <span style="color:#555">==</span> <span style="color:#f60">0</span> <span style="color:#555">?</span> <span style="color:#555">-</span>exts.<span style="color:#99f">immediate</span> : exts.immediate);

            <span style="color:#555">++</span>offset;
            start <span style="color:#555">+=</span> <span style="color:#f60">4</span>;
            end <span style="color:#555">-=</span> <span style="color:#f60">2</span>;
        } <span style="color:#069;font-weight:bold">else</span> <span style="color:#069;font-weight:bold">if</span> (T<span style="color:#a00;background-color:#faa">$</span>pcrel<span style="color:#a00;background-color:#faa">$</span>add(backup[offset])) {
            <span style="color:#069;font-weight:bold">union</span> {
                uint16_t value;

                <span style="color:#069;font-weight:bold">struct</span> {
                    uint16_t <span style="color:#99f">rd</span> : <span style="color:#f60">3</span>;
                    uint16_t <span style="color:#99f">rm</span> : <span style="color:#f60">3</span>;
                    uint16_t <span style="color:#99f">h2</span> : <span style="color:#f60">1</span>;
                    uint16_t <span style="color:#99f">h1</span> : <span style="color:#f60">1</span>;
                    <span style="color:#99f">uint16_t</span> : <span style="color:#f60">8</span>;
                };
            } bits <span style="color:#555">=</span> {backup[offset<span style="color:#555">+</span><span style="color:#f60">0</span>]};

            <span style="color:#069;font-weight:bold">if</span> (bits.h1) {
                <span style="color:#069;font-weight:bold">return</span> <span style="color:#366">false</span>;
            }

            <span style="color:#078;font-weight:bold">unsigned</span> rt(bits.rd <span style="color:#555">==</span> A<span style="color:#a00;background-color:#faa">$</span>r7 <span style="color:#555">?</span> A<span style="color:#a00;background-color:#faa">$</span><span style="color:#99f">r6</span> : A<span style="color:#a00;background-color:#faa">$</span>r7);

            buffer[start<span style="color:#555">+</span><span style="color:#f60">0</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>push_r(<span style="color:#f60">1</span> <span style="color:#555">&lt;&lt;</span> rt);
            buffer[start<span style="color:#555">+</span><span style="color:#f60">1</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>mov_rd_rm(rt, (bits.h1 <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">3</span>) <span style="color:#555">|</span> bits.rd);
            buffer[start<span style="color:#555">+</span><span style="color:#f60">2</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>ldr_rd_<span style="color:#a00;background-color:#faa">$</span>pc_im_4<span style="color:#a00;background-color:#faa">$</span>(bits.rd, T<span style="color:#a00;background-color:#faa">$</span>Label(start<span style="color:#555">+</span><span style="color:#f60">2</span>, end<span style="color:#555">-</span><span style="color:#f60">2</span>) <span style="color:#555">/</span> <span style="color:#f60">4</span>);
            buffer[start<span style="color:#555">+</span><span style="color:#f60">3</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>add_rd_rm((bits.h1 <span style="color:#555">&lt;&lt;</span> <span style="color:#f60">3</span>) <span style="color:#555">|</span> bits.rd, rt);
            buffer[start<span style="color:#555">+</span><span style="color:#f60">4</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>pop_r(<span style="color:#f60">1</span> <span style="color:#555">&lt;&lt;</span> rt);
            <span style="color:#555">*--</span>trailer <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uint32_t<span style="color:#555">&gt;</span>(area <span style="color:#555">+</span> offset) <span style="color:#555">+</span> <span style="color:#f60">4</span>;

            start <span style="color:#555">+=</span> <span style="color:#f60">5</span>;
            end <span style="color:#555">-=</span> <span style="color:#f60">2</span>;
        } <span style="color:#069;font-weight:bold">else</span> <span style="color:#069;font-weight:bold">if</span> (T<span style="color:#a00;background-color:#faa">$</span><span style="color:#f60">32</span>bit<span style="color:#a00;background-color:#faa">$</span>i(backup[offset])) {
            buffer[start<span style="color:#555">++</span>] <span style="color:#555">=</span> backup[offset];
            buffer[start<span style="color:#555">++</span>] <span style="color:#555">=</span> backup[<span style="color:#555">++</span>offset];
        } <span style="color:#069;font-weight:bold">else</span> {
            buffer[start<span style="color:#555">++</span>] <span style="color:#555">=</span> backup[offset];
        }
    }

    buffer[start<span style="color:#555">++</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>bx(A<span style="color:#a00;background-color:#faa">$</span>pc);
    buffer[start<span style="color:#555">++</span>] <span style="color:#555">=</span> T<span style="color:#a00;background-color:#faa">$</span>nop;

    uint32_t <span style="color:#555">*</span>transfer <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uint32_t <span style="color:#555">*&gt;</span>(buffer <span style="color:#555">+</span> start);
    transfer[<span style="color:#f60">0</span>] <span style="color:#555">=</span> A<span style="color:#a00;background-color:#faa">$</span>ldr_rd_<span style="color:#a00;background-color:#faa">$</span>rn_im<span style="color:#a00;background-color:#faa">$</span>(A<span style="color:#a00;background-color:#faa">$</span>pc, A<span style="color:#a00;background-color:#faa">$</span>pc, <span style="color:#f60">4</span> <span style="color:#555">-</span> <span style="color:#f60">8</span>);
    transfer[<span style="color:#f60">1</span>] <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uint32_t<span style="color:#555">&gt;</span>(area <span style="color:#555">+</span> used <span style="color:#555">/</span> <span style="color:#069;font-weight:bold">sizeof</span>(uint16_t)) <span style="color:#555">+</span> <span style="color:#f60">1</span>;

    info<span style="color:#555">-&gt;</span>setCallOriginalIns(<span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uint8_t <span style="color:#555">*&gt;</span>(buffer <span style="color:#555">+</span> pad) <span style="color:#555">+</span> <span style="color:#f60">1</span>);

    <span style="color:#069;font-weight:bold">return</span> <span style="color:#366">true</span>;
}
</code></pre></div>
<h5 id="msgetinstructionwiththumb">MSGetInstructionWithThumb</h5>

<p>调用    used += MSGetInstructionWithThumb(reinterpret_cast<uint8_t *>(area) + used);
MSGetInstructionWithThumb: 参数为(uint16_t*).
返回结果: 为这条指令是多少字节的指令.(4 or 2)</p>

<p>T$32bit$i的作用: (指令(ic) &amp; 1110 0000 0000 0000) &amp;&amp; (ic &amp; 0001 1000 0000 0000 != 0x0000);
第一个判断为确定高位3个bit(即bit[15], bit[14], bit[13])为1. 第二个判断为确保bit[12], bit[11]有值(即至少这两位有 1 位为 1).</p>

<p><code>其实就是判断是该thumb指令是否为thumb32指令,</code>
<code>thumb32指令的判断依据是 b[15:11] 为 0b11101或0b11110或0b11111.</code></p>

<p>MSGetInstructionWithThumb:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">        <span style="color:#069;font-weight:bold">static</span> size_t <span style="color:#c0f">MSGetInstructionWidthThumb</span>(<span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>start) {
            uint16_t <span style="color:#555">*</span>thumb(<span style="color:#069;font-weight:bold">reinterpret_cast</span><span style="color:#555">&lt;</span>uint16_t <span style="color:#555">*&gt;</span>(start));   <span style="color:#09f;font-style:italic">//
</span><span style="color:#09f;font-style:italic"></span>            <span style="color:#069;font-weight:bold">return</span> T<span style="color:#a00;background-color:#faa">$</span><span style="color:#f60">32</span>bit<span style="color:#a00;background-color:#faa">$</span>i(thumb[<span style="color:#f60">0</span>]) <span style="color:#555">?</span> <span style="color:#f60">4</span> <span style="color:#555">:</span> <span style="color:#f60">2</span>;
        }
</code></pre></div>
<p>T$32bit$i:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">        <span style="color:#069;font-weight:bold">static</span> <span style="color:#069;font-weight:bold">inline</span> <span style="color:#078;font-weight:bold">bool</span> T<span style="color:#a00;background-color:#faa">$</span><span style="color:#f60">32</span>bit<span style="color:#a00;background-color:#faa">$</span>i(uint16_t ic) {
            <span style="color:#069;font-weight:bold">return</span> ((ic <span style="color:#555">&amp;</span> <span style="color:#f60">0xe000</span>) <span style="color:#555">==</span> <span style="color:#f60">0xe000</span> <span style="color:#555">&amp;&amp;</span> (ic <span style="color:#555">&amp;</span> <span style="color:#f60">0x1800</span>) <span style="color:#555">!=</span> <span style="color:#f60">0x0000</span>);
        }
</code></pre></div>
<h4 id="分析memhelper类">分析MemHelper类</h4>

<p>有4个方法:</p>

<ol>
<li>static bool isFunctionAddr(void* addr);</li>
<li>static bool unProtectMemory(void* addr, uint32_t size);  remove 写保护</li>
<li>static bool protectMemory(void* addr, uint32_t size);    add    写保护</li>
<li>static void* createExecMemory(uint32_t size);            创建一个可执行的内存</li>
</ol>

<p>有4个field:</p>

<ol>
<li>std::vector<void*> all_memory_page;</li>
<li>void* current_page = nullptr;</li>
<li>uint32_t page_ptr  = 0;</li>
<li>static uint32_t page_size;      // 构造函数<code>page_size = sysconf(_SC_PAGESIZE).</code></li>
</ol>

<p>我们现在分析一下<code>createExecMemory(uint32_t size)</code>:</p>

<ol>
<li>可以看到, 分配内存的操作是通过<code>mmap</code>实现的.</li>
<li>all_memory_page是一个vector, 每个单位保存一个指针, 指向mmap的内存.</li>
</ol>

<p>createExecMemory:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#078;font-weight:bold">void</span> <span style="color:#555">*</span>FAHook<span style="color:#555">::</span>MemHelper<span style="color:#555">::</span>createExecMemory(uint32_t size) {
    <span style="color:#069;font-weight:bold">if</span>(size <span style="color:#555">&amp;</span> <span style="color:#f60">1</span>) {
        size <span style="color:#555">++</span>;
    }
    <span style="color:#069;font-weight:bold">if</span>(size <span style="color:#555">&gt;</span> page_size) {
        <span style="color:#069;font-weight:bold">return</span> <span style="color:#069;font-weight:bold">nullptr</span>;
    }
    <span style="color:#069;font-weight:bold">if</span>(gMemHelper.current_page <span style="color:#555">!=</span> <span style="color:#069;font-weight:bold">nullptr</span> <span style="color:#555">&amp;&amp;</span> page_size <span style="color:#555">-</span> gMemHelper.page_ptr_ <span style="color:#555">&gt;=</span> size) {
        <span style="color:#069;font-weight:bold">auto</span> funPtr <span style="color:#555">=</span> (<span style="color:#078;font-weight:bold">void</span><span style="color:#555">*</span>)((size_t)gMemHelper.current_page <span style="color:#555">+</span> gMemHelper.page_ptr_);
        gMemHelper.page_ptr_ <span style="color:#555">+=</span> size;
        <span style="color:#09f;font-style:italic">// Align 4
</span><span style="color:#09f;font-style:italic"></span>        <span style="color:#069;font-weight:bold">while</span>(gMemHelper.page_ptr_ <span style="color:#555">&amp;</span> <span style="color:#f60">0x3</span>) {
            gMemHelper.page_ptr_ <span style="color:#555">++</span>;
        }
        <span style="color:#069;font-weight:bold">return</span> funPtr;
    }
    <span style="color:#09f;font-style:italic">// scroll to next page
</span><span style="color:#09f;font-style:italic"></span>    <span style="color:#069;font-weight:bold">auto</span> newPage <span style="color:#555">=</span> mmap(<span style="color:#069;font-weight:bold">nullptr</span>, page_size, PROT_READ <span style="color:#555">|</span> PROT_WRITE <span style="color:#555">|</span> PROT_EXEC, MAP_ANONYMOUS <span style="color:#555">|</span> MAP_PRIVATE, <span style="color:#f60">0</span>, <span style="color:#f60">0</span>);
    <span style="color:#069;font-weight:bold">if</span>(newPage <span style="color:#555">!=</span> MAP_FAILED) {
        gMemHelper.alloc_memory_page_.push_back(newPage);

        gMemHelper.current_page <span style="color:#555">=</span> newPage;
        gMemHelper.page_ptr_ <span style="color:#555">=</span> <span style="color:#f60">0</span>;
        <span style="color:#069;font-weight:bold">return</span> <span style="color:#c0f">createExecMemory</span>(size);
    }
    <span style="color:#069;font-weight:bold">return</span> <span style="color:#069;font-weight:bold">nullptr</span>;
}
</code></pre></div>
<h4 id="分析doinhook">分析doInHook</h4>

<ol>
<li>主要操作: FAInHook::instance()-&gt;hookAll();</li>
<li>FAInHook::instance()-&gt;unHookAll();</li>
</ol>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#078;font-weight:bold">bool</span> <span style="color:#c0f">doInHook</span>() {
    <span style="color:#069;font-weight:bold">static</span> <span style="color:#078;font-weight:bold">bool</span> isHooked <span style="color:#555">=</span> <span style="color:#366">false</span>;
    <span style="color:#069;font-weight:bold">if</span> (isHooked) {
        isHooked <span style="color:#555">=</span> <span style="color:#366">false</span>;
        FAInHook<span style="color:#555">::</span>instance()<span style="color:#555">-&gt;</span>unhookAll();
    } <span style="color:#069;font-weight:bold">else</span> {
        isHooked <span style="color:#555">=</span> <span style="color:#366">true</span>;
        FAInHook<span style="color:#555">::</span>instance()<span style="color:#555">-&gt;</span>hookAll();
    }
    <span style="color:#069;font-weight:bold">return</span> <span style="color:#366">true</span>;
}
</code></pre></div>
<p>hookAll():</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4">void FAInHook::hookAll() {
    for(auto it: hook_map) {
        if(it.second-&gt;getHookStatus() == FAHook::REGISTERED) {
            Hook(it.second);
        }
    }
}</pre></div>
<p>进而转到Hook函数
1. 调用`enableJumpStub(info)
2. info-&gt;setHookStatus(FAHook::HOOKED)</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4">bool FAInHook::Hook(FAHook::HookInfo *info) {
    if(!FAHook::Instruction::enableJumpStub(info)) {
        return false;
    }
    info-&gt;setHookStatus(FAHook::HOOKED);
    return true;
}</pre></div>
<p>分析<code>enableJumpStub(info)</code>:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4">bool FAHook::Instruction::enableJumpStub(FAHook::HookInfo *info) {
    auto origAddr = getOriginalAddr(info);
    auto len = info-&gt;getJumpStubLen();
    auto stubAddr = info-&gt;getJumpStubBack();
    return patchMemory(origAddr, stubAddr, len);
}</pre></div>
<p>可以看到, 在得到了<code>origAddr</code>和<code>stubAddr</code>和<code>len</code>之后,我们会进入到patch函数<code>patchMemory</code>, 根据我们前面的分析, 它会patch原函数的入口指令的前(8 or 10?)个字节.</p>

<p>patchMemory:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4">bool FAHook::Instruction::patchMemory(void *dest, void *src, uint32_t len) {
    if(dest == nullptr || src == nullptr || len == 0) {
        return false;
    }
    if(!MemHelper::unProtectMemory(dest, len)) {
        return false;
    }

    memcpy(dest, src, len);
    MemHelper::protectMemory(dest, len);
#ifdef __arm__
    cacheflush((Elf_Addr)dest, (Elf_Addr)dest + len, 0);
#endif
    return true;
}</pre></div>
<p>首先会调用<code>unProtectMemory</code>函数来将对应内存修改为(rwx), 然后调用<code>memcpy</code>来修改内存, 最后调用<code>protectMemory</code>来修改对应内存为(r-x).</p>

<h2 id="总结">总结</h2>

<p>现在我们就基本对该项目进行了简单的分析, 我这里总结一下:</p>

<ol>
<li><p>registerHook
主要操作其实就是:</p>

<ul>
<li>createStub:  创建代理(这个代理就是要执行跳转到我们的<code>newFuncAddr</code>函数)</li>
<li>createCallOriginalStub:  call back代理(这个代理就是执行回调, 回调我们的<code>originalFunAddr</code>.) 主要涉及处理pc相关指令(原因在文中已经有介绍).
<br />
<br /></li>
</ul></li>

<li><p>doInHook</p>

<ul>
<li>主要就是patchMemory. patch我们originalFunAddr的函数起始处的几个指令为<code>stubInstruction</code>.之后函数涉及pc相关指令的修复, 方便继续执行原函数.</li>
</ul></li>

<li><p>unHook</p>

<ul>
<li>也是patchMemory.
就是将我们原函数的原始指令进行复原.</li>
</ul></li>
</ol>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">L0phTg</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2019-04-03</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content">true</span>
  </p>
</div>

    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://l0phtg.github.io/tags/hook/">Hook</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/iqiyi%E5%BC%80%E6%BA%90hook%E6%A1%86%E6%9E%B6xhook%E5%88%86%E6%9E%90/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Iqiyi开源hook框架XHook分析</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/%E8%A3%85%E6%9C%BA%E6%97%A5%E5%BF%97-deepin/">
            <span class="next-text nav-default">装机日志-deepin</span>
            <span class="prev-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>

  
  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="l0phtg:l0phtg@163.com" rel="me noopener" class="iconfont icon-email"
        title="email" target="_blank">
      </a>
      <a href="https://google.com" rel="me noopener" class="iconfont icon-google"
        title="google" target="_blank">
      </a>
      <a href="https://github.com/l0phtg" rel="me noopener" class="iconfont icon-github"
        title="github" target="_blank">
      </a>
  <a href="https://l0phtg.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml" class="iconfont icon-rss"
    title="rss" target="_blank">
  </a>
  </div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span><span class="author">
        l0phtg
        
      </span></span>

  
  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
<script type="text/javascript" src="/dist/jane.min.js?v=2.7.0"></script>





  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  











</body>
</html>
