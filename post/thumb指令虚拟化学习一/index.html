<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>thumb指令虚拟化学习(一) - L0phTg&#39;s Blog</title>
  <link rel="alternate" hreflang="zh-cn" href="https://l0phtg.github.io/" />

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="L0phTg" />
  <meta name="description" content="上半年接触过一些 app加固 的知识, 对 vm 这块一直空有兴趣而没有了解过; 最近, 阅读了几篇文章, 有所启发, 所以决定学习一下 vm 这块的一些操作.
主要内容分为:
 环境搭建 提取指令 capstone处理  
" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.49-DEV" />


<link rel="canonical" href="https://l0phtg.github.io/post/thumb%E6%8C%87%E4%BB%A4%E8%99%9A%E6%8B%9F%E5%8C%96%E5%AD%A6%E4%B9%A0%E4%B8%80/" />



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" href="/favicon.ico" />
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">




<link href="/dist/jane.min.css?v=2.7.0" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">



<link rel="stylesheet" href="/css/styles/dracula.css">

<link rel="stylesheet" href="/css/mermaid.css">


<meta property="og:title" content="thumb指令虚拟化学习(一)" />
<meta property="og:description" content="

上半年接触过一些 app加固 的知识, 对 vm 这块一直空有兴趣而没有了解过;  最近, 阅读了几篇文章, 有所启发, 所以决定学习一下 vm 这块的一些操作.

主要内容分为:


环境搭建
提取指令
capstone处理


" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://l0phtg.github.io/post/thumb%E6%8C%87%E4%BB%A4%E8%99%9A%E6%8B%9F%E5%8C%96%E5%AD%A6%E4%B9%A0%E4%B8%80/" /><meta property="article:published_time" content="2017-10-24T20:23:30&#43;08:00"/>
<meta property="article:modified_time" content="2019-04-03T19:59:08&#43;08:00"/>
<meta itemprop="name" content="thumb指令虚拟化学习(一)">
<meta itemprop="description" content="

上半年接触过一些 app加固 的知识, 对 vm 这块一直空有兴趣而没有了解过;  最近, 阅读了几篇文章, 有所启发, 所以决定学习一下 vm 这块的一些操作.

主要内容分为:


环境搭建
提取指令
capstone处理


">


<meta itemprop="datePublished" content="2017-10-24T20:23:30&#43;08:00" />
<meta itemprop="dateModified" content="2017-10-24T20:23:30&#43;08:00" />
<meta itemprop="wordCount" content="2949">



<meta itemprop="keywords" content="加固,capstone," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="thumb指令虚拟化学习(一)"/>
<meta name="twitter:description" content="

上半年接触过一些 app加固 的知识, 对 vm 这块一直空有兴趣而没有了解过;  最近, 阅读了几篇文章, 有所启发, 所以决定学习一下 vm 这块的一些操作.

主要内容分为:


环境搭建
提取指令
capstone处理


"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});  // 内联公式
  MathJax.Hub.Config({                                                      // support color
  showProcessingMessages: false,
  jax: ["input/TeX", "output/HTML-CSS"],
  TeX: {
    TagSide: "left",
    Macros: {
      RR: '{\\bf R}',
      bold: ['{\\bf #1}',1]
    }
  }
});
</script>


</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">L0phTg&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="https://gohugo.io">
        <li class="mobile-menu-item">external-link</li>
      </a>
  </ul>
</nav>

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      L0phTg&#39;s Blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/">Home</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/post/">Archives</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/tags/">Tags</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/categories/">Categories</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/about/">About</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://gohugo.io" rel="noopener" target="_blank">
              external-link
            <i class="iconfont icon-new-window"></i>
            </a>
          

        

      </li>
    
  </ul>
</nav>
  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">thumb指令虚拟化学习(一)</h1>
      
      <div class="post-meta">
        <span class="post-time"> 2017-10-24 </span>
        <div class="post-category">
            
              <a href="/categories/android/"> Android </a>
            
          </div>
        <span class="more-meta"> 约 2949 字 </span>
        <span class="more-meta"> 预计阅读 6 分钟 </span>
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#阅读资料">阅读资料</a></li>
<li><a href="#环境搭建">环境搭建:</a></li>
<li><a href="#本篇文章大致分为如下几个部分">本篇文章大致分为如下几个部分:</a>
<ul>
<li><a href="#提取指令">提取指令.</a>
<ul>
<li><a href="#用ida提取">用ida提取:</a></li>
<li><a href="#用radare2提取">用radare2提取</a></li>
</ul></li>
<li><a href="#了解capstone中对arm指令进行操作的函数-接口">了解capstone中对arm指令进行操作的函数 <code>接口</code></a>
<ul>
<li><a href="#从源代码中提供的-example-来初步了解capstone提供给我们的可用的-接口-的使用">从源代码中提供的<code>example</code>, 来初步了解capstone提供给我们的可用的<code>接口</code>的使用</a></li>
<li><a href="#观察源代码中的-bindings-python-capstone-init-py-来了解-cs-和-csinsn-的实现">观察源代码中的<code>/bindings/python/capstone/__init__.py</code>来了解<strong>CS</strong> 和 <strong>CsInsn</strong> 的实现:</a></li>
<li><a href="#这里我们先简单写一个-py-来对上面的部分函数进行应用">这里我们先简单写一个.py, 来对上面的部分函数进行应用</a></li>
</ul></li>
<li><a href="#了解-thumb-的指令编码">了解 thumb 的指令编码:</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p><img src="/thumb-vmp/thumb16.png" alt="" /></p>

<p>上半年接触过一些 <strong>app加固</strong> 的知识, 对 <strong>vm</strong> 这块一直空有兴趣而没有了解过;  最近, 阅读了几篇文章, <code>有所启发</code>, 所以决定学习一下 <strong>vm</strong> 这块的一些操作.</p>

<p>主要内容分为:</p>

<ul>
<li>环境搭建</li>
<li>提取指令</li>
<li>capstone处理</li>
</ul>

<p></p>

<h2 id="阅读资料">阅读资料</h2>

<p><a href="https://github.com/knownsec/KCon/blob/master/2017/%5BKCon%202017%5D0827_3_%E9%99%88%E6%84%89%E9%91%AB_%E7%AC%AC%E4%BA%94%E4%BB%A3%E5%8A%A0%E5%9B%BA%E6%8A%80%E6%9C%AFARM%20VMP%E5%8E%9F%E7%90%86%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%BA%94%E7%94%A8.pdf">Kcon2017 第五代加固技术ARM VMP原理与应用</a></p>

<p><a href="http://www.cnblogs.com/2014asm/p/6534897.html">ARM平台指令虚拟化探索</a></p>

<h2 id="环境搭建">环境搭建:</h2>

<ul>
<li>需要安装python的capstone模块, 可以直接使用pip安装. (另外: <strong>强烈建议下载capstone源码, 以便随时阅读</strong>.)</li>
</ul>

<pre><code class="language-bash">
    sudo apt install libcapstone3
    sudo apt install libcapstone-dev
    pip install capstone

</code></pre>

<ul>
<li><p>ida/radare2 <code>在本节中, 提取指令的时候会用到</code>.</p></li>

<li><p>arm官方文档(<a href="https://yurichev.com/mirrors/ARMv8-A_Architecture_Reference_Manual_(Issue_A.a).pdf">https://yurichev.com/mirrors/ARMv8-A_Architecture_Reference_Manual_(Issue_A.a).pdf</a>)</p></li>
</ul>

<h2 id="本篇文章大致分为如下几个部分">本篇文章大致分为如下几个部分:</h2>

<ol>
<li><p>手动提取编译好的可执行文件中的 <strong>你想要加密的函数</strong>, 并转换为 <strong>16进制的格式</strong>.</p></li>

<li><p>初步了解 <strong>capstone</strong> 中的 <strong>对Arm指令进行处理的操作函数</strong>.</p></li>

<li><p>了解 <strong>thumb指令编码</strong> , <code>此处研究thumb的原因是: 在提出函数的bytes时, 发现自定义的函数, 都被转换成了thumb指令的格式, 所以笔者先研究thumb;  当然, 要知道, thumb并不是独立于arm存在的, thumb的存在是为了提高效率</code>.</p></li>

<li><p>设计自己的一套 <strong>指令集</strong> , <code>很简单的一套指令集, 能模拟常见的thumb指令, 例如 push, pop, str, ldr, add, sub, mov, cmp, blx ...</code>.</p></li>

<li><p>写代码, <code>此处参考了capstone源码中的/bindings/python/capstone/* 中的有关代码, 初学py, 代码写的差, 有什么建议还请多多交流)</code>.</p></li>
</ol>

<h3 id="提取指令">提取指令.</h3>

<p>我们提取的是下面程序中的 <strong>judge</strong> 函数.</p>

<h4 id="用ida提取">用ida提取:</h4>

<p>我们将会在这篇文章中用到的程序:</p>

<pre><code class="language-c">#include &lt;stdio.h&gt;

char key[16] = {'a', 'a', 'a', 'a', '1', '1', '1', '1', 'q', 'r', 'c', 'o', 'b', 'g', 's', 'k'};

int judge(const char *s)
{
    int ret = 1;
    char c[16] = {'a', 'b', 'c', 'd', '1', '2', '3', '4', 'q', 's', 'e', 'r', 'b', 'h', 'u', 'n'};
    int i;
    for (i = 0; i &lt; 16; i++)
    {
        switch(i % 4)   
        {
        case 0: 
            if (s[i]  == c[i])
                continue;
            break;  
        case 1:
            if (s[i] + 1 == c[i])
                continue;
            break;
        case 2:
            if (s[i] + 2 == c[i])
                continue;
            break;
        case 3:
            if (s[i] + 3 == c[i])
                continue; 
            break;
        } 
        ret = 0; 
    }
    return ret;
}

int main(int argc, char *argv[])
{
    printf(&quot;hello World\n&quot;);
    char a[16];
    scanf(&quot;%s&quot;, a);

    if (judge(a) == 1)
        printf(&quot;ok&quot;);
    else
        printf(&quot;error&quot;);

    return 0;
}
</code></pre>

<p>用ndk-build编译成armv7a可执行程序后, 放入ida中, 用idc脚本提::</p>

<p>idc脚本, start为judge函数的起始地址, end为judge函数的结束地址.</p>

<pre><code class="language-c">#include &lt;idc.idc&gt;

static main() {
    auto start, end, fd, i, inst;
    fd = fopen(&quot;D:\\idaResult\\armOpcodeByte.txt&quot;, &quot;wt+&quot;);
    start = 0x863c;
    end = 0x86BA;
    
    for(i = start; i &lt; end; i++) {
        inst = Byte(i);
        fprintf(fd, &quot;\\x%02x&quot;, inst);
    }
    fclose(fd);
}
</code></pre>

<p>提取出来后的结果:</p>

<pre><code class="language-python">\x1f\x49\xf0\xb5\x79\x44\x09\x68\x87\xb0\x07\x46\x0b\x68\x01\xaa\x0d\x46\x16\x46\x05\x93\x1b\x4b\x7b\x44\x03\xf1\x10\x0e\x18\x68\x08\x33\x53\xf8\x04\x1c\x73\x45\x14\x46\x03\xc4\x22\x46\xf6\xd1\x3a\x46\x00\x23\x01\x20\x03\xf0\x03\x01\x02\x29\x09\xd0\x03\x29\x0a\xd0\x01\x29\x02\xd0\x14\x78\xf1\x5c\x08\xe0\x11\x78\x01\x31\x04\xe0\x11\x78\x02\x31\x01\xe0\x11\x78\x03\x31\xf4\x5c\x01\x33\xa1\x42\x18\xbf\x00\x20\x10\x2b\x02\xf1\x01\x02\xe3\xd1\x05\x9a\x2b\x68\x9a\x42\x01\xd0\xff\xf7\x0a\xef\x07\xb0\xf0\xbd
</code></pre>

<h4 id="用radare2提取">用radare2提取</h4>

<p>(才发现原来radare2 v2.0都已经发布了)</p>

<p><code>对r2语法不做讲解了, 网上也有了一些文章, 大家可以去看</code>.  笔者本身也不是很熟悉~</p>

<pre><code class="language-bash">username-l0phtg@L0phTg:armeabi-v7a$ r2 test
 -- Interpret radare2 scripts with '. &lt;path-to-script&gt;'. Similar to the bash source alias command.
[0x000085a0]&gt; aa
[x] Analyze all flags starting with sym. and entry0 (aa)
[0x000085a0]&gt; afl~judge
0x0000863c   17 126          sym.judge
[0x000085a0]&gt; 0x863c
[0x0000863c]&gt; pcp 126
import struct
buf = struct.pack (&quot;126B&quot;, *[
0x1f,0x49,0xf0,0xb5,0x79,0x44,0x09,0x68,0x87,0xb0,0x07,
0x46,0x0b,0x68,0x01,0xaa,0x0d,0x46,0x16,0x46,0x05,0x93,
0x1b,0x4b,0x7b,0x44,0x03,0xf1,0x10,0x0e,0x18,0x68,0x08,
0x33,0x53,0xf8,0x04,0x1c,0x73,0x45,0x14,0x46,0x03,0xc4,
0x22,0x46,0xf6,0xd1,0x3a,0x46,0x00,0x23,0x01,0x20,0x03,
0xf0,0x03,0x01,0x02,0x29,0x09,0xd0,0x03,0x29,0x0a,0xd0,
0x01,0x29,0x02,0xd0,0x14,0x78,0xf1,0x5c,0x08,0xe0,0x11,
0x78,0x01,0x31,0x04,0xe0,0x11,0x78,0x02,0x31,0x01,0xe0,
0x11,0x78,0x03,0x31,0xf4,0x5c,0x01,0x33,0xa1,0x42,0x18,
0xbf,0x00,0x20,0x10,0x2b,0x02,0xf1,0x01,0x02,0xe3,0xd1,
0x05,0x9a,0x2b,0x68,0x9a,0x42,0x01,0xd0,0xff,0xf7,0x0a,
0xef,0x07,0xb0,0xf0,0xbd])
[0x0000863c]&gt;
</code></pre>

<h3 id="了解capstone中对arm指令进行操作的函数-接口">了解capstone中对arm指令进行操作的函数 <code>接口</code></h3>

<h4 id="从源代码中提供的-example-来初步了解capstone提供给我们的可用的-接口-的使用">从源代码中提供的<code>example</code>, 来初步了解capstone提供给我们的可用的<code>接口</code>的使用</h4>

<p>我们参考的主要是 <code>/bindings/python/test_arm.py</code> 和 <code>/bindings/python/test_detail.py</code>这两个文件:</p>

<ol>
<li>test_arm.py   <code>源代码过多, 这里就不全部都放上来了</code></li>
</ol>

<pre><code class="language-python">#!/usr/bin/env python

# Capstone Python bindings, by Nguyen Anh Quynnh &lt;aquynh@gmail.com&gt;

from __future__ import print_function
from capstone import *
from capstone.arm import *
from xprint import to_hex, to_x, to_x_32

ARM_CODE = b&quot;\xED\xFF\xFF\xEB\x04\xe0\x2d\xe5\x00\x00\x00\x00\xe0\x83\x22\xe5\xf1\x02\x03\x0e\x00\x00\xa0\xe3\x02\x30\xc1\xe7\x00\x00\x53\xe3\x00\x02\x01\xf1\x05\x40\xd0\xe8\xf4\x80\x00\x00&quot;
THUMB_CODE = b&quot;\x70\x47\x00\xf0\x10\xe8\xeb\x46\x83\xb0\xc9\x68\x1f\xb1\x30\xbf\xaf\xf3\x20\x84&quot;

all_tests = (
        (CS_ARCH_ARM, CS_MODE_ARM, ARM_CODE, &quot;ARM&quot;, None),
        (CS_ARCH_ARM, CS_MODE_THUMB, THUMB_CODE, &quot;Thumb&quot;, None),
        )

def print_insn_detail(insn):
    # print address, mnemonic and operands
    print(&quot;0x%x:\t%s\t%s&quot; % (insn.address, insn.mnemonic, insn.op_str))

    # &quot;data&quot; instruction generated by SKIPDATA option has no detail
    if insn.id == 0:
        return

    if len(insn.operands) &gt; 0:
        print(&quot;\top_count: %u&quot; % len(insn.operands))
        c = 0
        for i in insn.operands:
            if i.type == ARM_OP_REG:
                print(&quot;\t\toperands[%u].type: REG = %s&quot; % (c, insn.reg_name(i.reg)))
            if i.type == ARM_OP_IMM:
                print(&quot;\t\toperands[%u].type: IMM = 0x%s&quot; % (c, to_x_32(i.imm)))
...............................
            if i.type == ARM_OP_MEM:
                print(&quot;\t\toperands[%u].type: MEM&quot; % c)
                if i.mem.base != 0:
                    print(&quot;\t\t\toperands[%u].mem.base: REG = %s&quot; \
                        % (c, insn.reg_name(i.mem.base)))
                if i.mem.index != 0:
                    print(&quot;\t\t\toperands[%u].mem.index: REG = %s&quot; \
                        % (c, insn.reg_name(i.mem.index)))
                if i.mem.scale != 1:
                    print(&quot;\t\t\toperands[%u].mem.scale: %u&quot; \
                        % (c, i.mem.scale))
                if i.mem.disp != 0:
                    print(&quot;\t\t\toperands[%u].mem.disp: 0x%s&quot; \
                        % (c, to_x_32(i.mem.disp)))
...............................
            c += 1

    if insn.update_flags:
        print(&quot;\tUpdate-flags: True&quot;)
    if insn.writeback:
        print(&quot;\tWrite-back: True&quot;)
    if not insn.cc in [ARM_CC_AL, ARM_CC_INVALID]:
        print(&quot;\tCode condition: %u&quot; % insn.cc)
...............................

### Test class Cs
def test_class():

    for (arch, mode, code, comment, syntax) in all_tests:
        print(&quot;*&quot; * 16)
        print(&quot;Platform: %s&quot; % comment)
        print(&quot;Code: %s&quot; % to_hex(code))
        print(&quot;Disasm:&quot;)

        try:
            md = Cs(arch, mode)
            if syntax:
                md.syntax = syntax
            md.detail = True
            for insn in md.disasm(code, 0x80001000):
                print_insn_detail(insn)
                print ()
            print (&quot;0x%x:\n&quot; % (insn.address + insn.size))
        except CsError as e:
            print(&quot;ERROR: %s&quot; % e)


if __name__ == '__main__':
    test_class()
</code></pre>

<p>观察<code>test_arm.py</code>, 我们可以看到的重要的一些操作有:</p>

<pre><code class="language-python">md = Cs(arch, mode)
for insn in md.disasm(code, 0x80001000):
    print_insn_detail(insn)
</code></pre>

<p>首先通过<code>md = Cs(arch, mode)</code>来选择我们的架构, 然后调用<code>md.disasm</code>返回 指令(insn) (这里Cs.disasm就是一个生成器, 参看py语法)
然后打印<code>insn</code>的细节(助记符, 操作数, 以及每个操作数的类型等)</p>

<p>打印的时候(这里我只列举了部分操作):
- 我们可以发现 <strong>针对指令</strong> 调用了 <strong>insn.address</strong>, <strong>insn.mnemonic</strong>,  <strong>insn.op_str</strong>, <strong>insn.operands</strong>, <strong>insn.update_flags</strong>, <strong>insn.cc</strong>&hellip;..
- 针对 <strong>操作数</strong> 调用了 <strong>i.type</strong>, <strong>i.reg</strong>, <strong>i.mem</strong>&hellip;.</p>

<ol>
<li>test_detail.py (省略了一些和上面test_arm.py相似的代码)</li>
</ol>

<pre><code class="language-python">..........
def print_detail(insn):
    print(&quot;0x%x:\t%s\t%s  // insn-ID: %u, insn-mnem: %s&quot; \
        % (insn.address, insn.mnemonic, insn.op_str, insn.id, \
        insn.insn_name()))

    # &quot;data&quot; instruction generated by SKIPDATA option has no detail
    if insn.id == 0:
        return

    if len(insn.regs_read) &gt; 0:
        print(&quot;\tImplicit registers read: &quot;, end=''),
        for m in insn.regs_read:
            print(&quot;%s &quot; % insn.reg_name(m), end=''),
        print()

    if len(insn.regs_write) &gt; 0:
        print(&quot;\tImplicit registers modified: &quot;, end=''),
        for m in insn.regs_write:
            print(&quot;%s &quot; % insn.reg_name(m), end=''),
        print()

    if len(insn.groups) &gt; 0:
        print(&quot;\tThis instruction belongs to groups: &quot;, end=''),
        for m in insn.groups:
            print(&quot;%s &quot; % insn.group_name(m), end=''),
        print()``
        ....................................

</code></pre>

<p>操作很明显:
<strong>insn.regs_read</strong>, <strong>insn.regs_write</strong>, <strong>insn.groups</strong>.</p>

<h4 id="观察源代码中的-bindings-python-capstone-init-py-来了解-cs-和-csinsn-的实现">观察源代码中的<code>/bindings/python/capstone/__init__.py</code>来了解<strong>CS</strong> 和 <strong>CsInsn</strong> 的实现:</h4>

<pre><code class="language-python">class Cs(object):
    def __init__(self, arch, mode):
        ....
        ....省略


    # Disassemble binary &amp; return disassembled instructions in CsInsn objects   反汇编二进制代码&amp;&amp; 返回反汇编的指令in CsInsn对象中
    def disasm(self, code, offset, count=0):
        all_insn = ctypes.POINTER(_cs_insn)()
        '''if not _python2:
            print(code)
            code = code.encode()
            print(code)'''
        # Hack, unicorn's memory accessors give you back bytearrays, but they
        # cause TypeErrors when you hand them into Capstone.
        if isinstance(code, bytearray):
            code = bytes(code)
        res = _cs.cs_disasm(self.csh, code, len(code), offset, count, ctypes.byref(all_insn))*************
        if res &gt; 0:
            try:
                for i in range(res):
                    yield CsInsn(self, all_insn[i])         ## all_info*********************************** 重点操作
            finally:
                _cs.cs_free(all_insn, res)
        else:
            status = _cs.cs_errno(self.csh)
            if status != CS_ERR_OK:
                raise CsError(status)
            return
            yield
</code></pre>

<p>通过观察<strong>Cs</strong>这个类的实现, 我们发现了它是一个生成器, 一直返回<strong>CsInsn</strong> 这个类的对象, 现在我们来看一下CsInsn 这个类的实现(从名字可以就可以看出来, 它保存了我们每条指令的性质)</p>

<pre><code class="language-python">▼ CsInsn : class
   +__init__ : function
   +id : function           @property
   +address : function      @property // 返回 指令的地址
   +size : function         @property // 返回 大小
   +bytes : function        @property // 返回 字节码 []
   +mnemonic : function     @property // 返回 指令名称(助记符)
   +op_str : function       @property // 返回 操作string
   +regs_read : function    @property // 返回 会被*隐式*读的寄存器[]
   +regs_write : function   @property // 返回 会被*隐式*写的寄存器[]
   +groups : function       @property // 指令的group
   -__gen_detail : function
   -__getattr__ : function
   +errno : function
   +reg_name : function   (self, reg_id)  // 返回寄存器的名称
   +insn_name : function                  // 返回指令名称, 不同于mnemonic
   +group_name : function
   +group : function
   +reg_read : function   (self, reg_id)  // 识别该寄存器会被隐式read
   +reg_write : function  (self, reg_id)  // 识别该寄存器是否会被隐式 write
   +op_count : function
   +op_find : function
</code></pre>

<p>这里我罗列了一下它的所有操作,  我们下面写代码的时候会用到.</p>

<h4 id="这里我们先简单写一个-py-来对上面的部分函数进行应用">这里我们先简单写一个.py, 来对上面的部分函数进行应用</h4>

<p>我们可以先看一下输出结果:</p>

<pre><code class="language-python">l0phtg@l0phtg-PC:~/blogTest$ python test.py 
0x1000: push    {r4, r6, r7, lr}
id:426  groups:[150, 151]   size:2  
bytes:  0xd0 0xb5 
    op_count: 4
        operands[0].type: REG = r4
        operands[1].type: REG = r6
        operands[2].type: REG = r7
        operands[3].type: REG = lr

0x1002: pop {r4, r6, r7, pc}
id:425  groups:[150, 151]   size:2  
bytes:  0xd0 0xbd 
    op_count: 4
        operands[0].type: REG = r4
        operands[1].type: REG = r6
        operands[2].type: REG = r7
        operands[3].type: REG = pc

0x1004: beq #0x100e
id:17   groups:[150, 151, 1]    size:2  
bytes:  0x3 0xd0 
    op_count: 1
        operands[0].type: IMM = 0x100e

0x1006: movs    r0, #0
id:80   groups:[150, 151]   size:2  
bytes:  0x0 0x20 
    op_count: 2
        operands[0].type: REG = r0
        operands[1].type: IMM = 0x0
    Update-flags: True
</code></pre>

<p>每条指令的指令名称, 指令操作数, 操作数类型, 该指令是否更新flag都显示了出来.</p>

<p>下面的代码(参考test_arm.py的实现)</p>

<pre><code class="language-python">#!/usr/bin/env python2
#-*- coding:utf-8 -*-

import sys
from capstone import *
from capstone.arm import *
from xprint import to_hex, to_x, to_x_32

my_thumb_code = b&quot;\xd0\xb5\xd0\xbd\x03\xd0\x00\x20&quot;


def print_insn_detail(insn):
    print(&quot;0x%x:\t%s\t%s&quot; % (insn.address, insn.mnemonic, insn.op_str))
    print(&quot;id:%d\tgroups:%s\tsize:%x\t&quot; % (insn.id, insn.groups, insn.size))
    sys.stdout.write('bytes:\t')
    for i in insn.bytes:
        sys.stdout.write(&quot;%s &quot; % hex(i))
    sys.stdout.write('\n')

    if len(insn.operands) &gt; 0:
        print(&quot;\top_count: %u&quot; % len(insn.operands))
        c = 0
        for i in insn.operands:
            if i.type == ARM_OP_REG:
                print(&quot;\t\toperands[%u].type: REG = %s&quot; % (c, insn.reg_name(i.reg)))
            if i.type == ARM_OP_IMM:
                print(&quot;\t\toperands[%u].type: IMM = 0x%s&quot; % (c, to_x_32(i.imm)))
            if i.type == ARM_OP_PIMM:
                print(&quot;\t\toperands[%u].type: P-IMM = %u&quot; % (c, i.imm))
            if i.type == ARM_OP_CIMM:
                print(&quot;\t\toperands[%u].type: C-IMM = %u&quot; % (c, i.imm))
            if i.type == ARM_OP_FP:
                print(&quot;\t\toperands[%u].type: FP = %f&quot; % (c, i.fp))
            if i.type == ARM_OP_SYSREG:
                print(&quot;\t\toperands[%u].type: SYSREG = %u&quot; % (c, i.reg))
            if i.type == ARM_OP_SETEND:
                if i.setend == ARM_SETEND_BE:
                    print(&quot;\t\toperands[%u].type: SETEND = be&quot; % c)
                else:
                    print(&quot;\t\toperands[%u].type: SETEND = le&quot; % c)
            if i.type == ARM_OP_MEM:
                print(&quot;\t\toperands[%u].type: MEM&quot; % c)
                if i.mem.base != 0:
                    print(&quot;\t\t\toperands[%u].mem.base: REG = %s&quot; \
                        % (c, insn.reg_name(i.mem.base)))
                if i.mem.index != 0:
                    print(&quot;\t\t\toperands[%u].mem.index: REG = %s&quot; \
                        % (c, insn.reg_name(i.mem.index)))
                if i.mem.scale != 1:
                    print(&quot;\t\t\toperands[%u].mem.scale: %u&quot; \
                        % (c, i.mem.scale))
                if i.mem.disp != 0:
                    print(&quot;\t\t\toperands[%u].mem.disp: 0x%s&quot; \
                        % (c, to_x_32(i.mem.disp)))

            if i.shift.type != ARM_SFT_INVALID and i.shift.value:
                print(&quot;\t\t\tShift: %u = %u&quot; \
                    % (i.shift.type, i.shift.value))
            if i.vector_index != -1:
                print(&quot;\t\t\toperands[%u].vector_index = %u&quot; %(c, i.vector_index))
            if i.subtracted:
                print(&quot;\t\t\toperands[%u].subtracted = True&quot; %c)

            c += 1

    if insn.update_flags:
        print(&quot;\tUpdate-flags: True&quot;)

def test_class():

    md = Cs(CS_ARCH_ARM, CS_MODE_THUMB)
    md.detail=True
    for insn in md.disasm(my_thumb_code, 0x1000):
        print_insn_detail(insn)
        sys.stdout.write('\n')

if __name__ == '__main__':
    test_class()
</code></pre>

<h3 id="了解-thumb-的指令编码">了解 thumb 的指令编码:</h3>

<p>在前面环境搭建的时候, 我向大家推荐了arm的一个文档, 本节主要针对该文档进行分析.</p>

<p>首先定位到第<code>F3</code>章节, 观看目录:</p>

<pre><code>Chapter F3

T32 Base Instruction Set Encoding

This chapter introduces the T32 instruction set and describes how it uses the ARM programmers’ model. It contains

the following sections:


• T32 instruction set encoding on page F3-2432.

• 16-bit T32 instruction encoding on page F3-2435.

• 32-bit T32 instruction encoding on page F3-2442.

</code></pre>

<p>我们在此分析的是<strong>16-bit T32 instruction</strong>, 再次定位到<code>F3-2435</code>.</p>

<p><img src="/thumb-vmp/thumb16.png" alt="" /></p>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">L0phTg</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2019-04-03</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content">原创文章，如需转载请注明文章作者和出处。谢谢！</span>
  </p>
</div>

    
    

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/%E5%8A%A0%E5%9B%BA/">加固</a>
          
          <a href="/tags/capstone/">capstone</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/%E8%A3%85%E6%9C%BA%E6%97%A5%E5%BF%97-deepin/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">装机日志-deepin</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E5%92%8Candroidlinker%E5%8A%A0%E8%BD%BD-so%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
            <span class="next-text nav-default">elf文件格式和AndroidLinker加载.so的源码分析</span>
            <span class="prev-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
    

  

  

  
  </article>
        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="l0phtg:l0phtg@163.com" rel="me noopener" class="iconfont icon-email"
        title="email" target="_blank">
      </a>
      <a href="https://google.com" rel="me noopener" class="iconfont icon-google"
        title="google" target="_blank">
      </a>
      <a href="https://github.com/l0phtg" rel="me noopener" class="iconfont icon-github"
        title="github" target="_blank">
      </a>
  <a href="https://l0phtg.github.io/index.xml" rel="noopener" type="application/rss+xml" class="iconfont icon-rss"
    title="rss" target="_blank">
  </a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span><span class="author">l0phtg</span></span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>
<script type="text/javascript" src="/dist/jane.min.js?v=2.7.0"></script>
  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML'></script>





<script src="/js/highlight.pack.js"></script>

<script src="/js/mermaid.min.js"></script>


<script>hljs.initHighlightingOnLoad();</script>
<script> mermaid.initialize({ startOnLoad: true });</script>

</body>
</html>
