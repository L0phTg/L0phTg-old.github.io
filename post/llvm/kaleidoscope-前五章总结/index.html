<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Kaleidoscope: 前五章总结 - L0phTg&#39;s Blog</title>
  <link rel="alternate" hreflang="zh-cn" href="https://l0phtg.github.io/" />

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="L0phTg" />
  <meta name="description" content="对前五章做了一个总结, 侧重Codegen部分.

" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.49-DEV" />


<link rel="canonical" href="https://l0phtg.github.io/post/llvm/kaleidoscope-%E5%89%8D%E4%BA%94%E7%AB%A0%E6%80%BB%E7%BB%93/" />



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" href="/favicon.ico" />
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">




<link href="/dist/jane.min.css?v=2.7.0" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">



<link rel="stylesheet" href="/css/styles/dracula.css">

<link rel="stylesheet" href="/css/mermaid.css">


<meta property="og:title" content="Kaleidoscope: 前五章总结" />
<meta property="og:description" content="对前五章做了一个总结, 侧重Codegen部分.

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://l0phtg.github.io/post/llvm/kaleidoscope-%E5%89%8D%E4%BA%94%E7%AB%A0%E6%80%BB%E7%BB%93/" /><meta property="article:published_time" content="2019-04-15T17:58:13&#43;08:00"/>
<meta property="article:modified_time" content="2019-04-15T19:30:50&#43;08:00"/>
<meta itemprop="name" content="Kaleidoscope: 前五章总结">
<meta itemprop="description" content="对前五章做了一个总结, 侧重Codegen部分.

">


<meta itemprop="datePublished" content="2019-04-15T17:58:13&#43;08:00" />
<meta itemprop="dateModified" content="2019-04-15T17:58:13&#43;08:00" />
<meta itemprop="wordCount" content="2953">



<meta itemprop="keywords" content="llvm,Kaleidoscope," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kaleidoscope: 前五章总结"/>
<meta name="twitter:description" content="对前五章做了一个总结, 侧重Codegen部分.

"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});  // 内联公式
  MathJax.Hub.Config({                                                      // support color
  showProcessingMessages: false,
  jax: ["input/TeX", "output/HTML-CSS"],
  TeX: {
    TagSide: "left",
    Macros: {
      RR: '{\\bf R}',
      bold: ['{\\bf #1}',1]
    }
  }
});
</script>


</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">L0phTg&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="https://gohugo.io">
        <li class="mobile-menu-item">external-link</li>
      </a>
  </ul>
</nav>

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      L0phTg&#39;s Blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/">Home</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/post/">Archives</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/tags/">Tags</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/categories/">Categories</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="/about/">About</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://gohugo.io" rel="noopener" target="_blank">
              external-link
            <i class="iconfont icon-new-window"></i>
            </a>
          

        

      </li>
    
  </ul>
</nav>
  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Kaleidoscope: 前五章总结</h1>
      
      <div class="post-meta">
        <span class="post-time"> 2019-04-15 </span>
        <div class="post-category">
            
              <a href="/categories/llvm/"> llvm </a>
            
          </div>
        <span class="more-meta"> 约 2953 字 </span>
        <span class="more-meta"> 预计阅读 6 分钟 </span>
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#kaleidoscope支持的语法">Kaleidoscope支持的语法</a></li>
<li><a href="#词法分析">词法分析</a></li>
<li><a href="#抽象语法树">抽象语法树</a></li>
<li><a href="#生成抽象语法树-ast">生成抽象语法树(AST)</a>
<ul>
<li><a href="#expr的-ast-生成">Expr的(AST)生成</a></li>
<li><a href="#函数定义和申明的ast生成">函数定义和申明的AST生成</a></li>
</ul></li>
<li><a href="#codegen-产生llvm-ir">Codegen(产生LLVM IR)</a>
<ul>
<li><a href="#四个基本表达式的codegen">四个基本表达式的codegen</a></li>
<li><a href="#if-then-else">if/then/else</a>
<ul>
<li><a href="#kaleidoscpe-if-then-else">Kaleidoscpe: if/then/else</a></li>
<li><a href="#未经优化的llvm-ir">未经优化的LLVM IR</a>
<ul>
<li><a href="#ir解析">IR解析</a></li>
</ul></li>
<li><a href="#if-then-else-s-cfg">if/then/else&rsquo;s CFG</a>
<ul>
<li><a href="#if-then-else-s-dominator-判断哪里需要插入phi函数">if/then/else&rsquo;s dominator (判断哪里需要插入phi函数)</a></li>
</ul></li>
<li><a href="#builder创建ir指令">Builder创建IR指令</a>
<ul>
<li><a href="#创建cmp指令">创建cmp指令</a></li>
<li><a href="#创建条件br指令">创建条件br指令</a></li>
<li><a href="#创建直接br指令">创建直接br指令</a></li>
<li><a href="#创建phi指令">创建phi指令</a></li>
<li><a href="#创建block">创建Block</a></li>
<li><a href="#irbuilder中插入block">IRBuilder中插入Block</a></li>
<li><a href="#将未添加的block添加到函数中">将未添加的Block添加到函数中</a></li>
</ul></li>
<li><a href="#builder流程图">Builder流程图</a></li>
</ul></li>
<li><a href="#loop">Loop</a>
<ul>
<li><a href="#kaleidoscope-for">Kaleidoscope: for</a></li>
<li><a href="#未经优化的llvm-ir-1">未经优化的LLVM IR</a>
<ul>
<li><a href="#ir解析-1">IR解析</a></li>
</ul></li>
<li><a href="#for-s-cfg">for&rsquo;s CFG</a></li>
<li><a href="#builder流程图-1">Builder流程图</a></li>
</ul></li>
</ul></li>
<li><a href="#jit和优化">JIT和优化</a></li>
<li><a href="#driver">Driver</a></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>对前五章做了一个总结, 侧重Codegen部分.</p>

<p></p>

<h1 id="kaleidoscope支持的语法">Kaleidoscope支持的语法</h1>

<p><code>表达式运算</code>:</p>

<pre><code class="language-c">4+5;
5-1;
5*10;
10/5;
</code></pre>

<p><code>函数定义</code>:</p>

<pre><code class="language-c">def bar(a) foo(a, 4.0) + bar(31337);
</code></pre>

<p><code>函数调用</code>:</p>

<pre><code class="language-c">cos(1.234);
</code></pre>

<p><code>if/then/else</code>:</p>

<pre><code class="language-c">extern foo();
extern bar();
def baz(x) if x then foo() else bar();
</code></pre>

<p><code>for</code>:</p>

<pre><code class="language-c">extern putchard(char);
def printstar(n)
  for i = 1, i &lt; n, 1.0 in
    putchard(42);  # ascii 42 = '*'

# print 100 '*' characters
printstar(100);
</code></pre>

<h1 id="词法分析">词法分析</h1>

<p>词法分析很简单. 我这里简单画了下处理的流程图.</p>

<p><img src="/docs-pic/llvm/Lexer And Parser.png" alt="" /></p>

<p>具体的分析请看: <a href="https://l0phtg.github.io/post/kaleidoscope-tutorial-introduction-and-lexer/">Lexer and Parse</a></p>

<h1 id="抽象语法树">抽象语法树</h1>

<p><img src="/docs-pic/llvm/AST.png" alt="" /></p>

<h1 id="生成抽象语法树-ast">生成抽象语法树(AST)</h1>

<p>这块比较简单. 简单介绍下:</p>

<h2 id="expr的-ast-生成">Expr的(AST)生成</h2>

<p>我们对所有的表达式进行集中处理.</p>

<pre><code class="language-c++">/// expression
///   ::= primary binoprhs
///
static std::unique_ptr&lt;ExprAST&gt; ParseExpression() {
  auto LHS = ParsePrimary();
  if (!LHS)
    return nullptr;

  return ParseBinOpRHS(0, std::move(LHS));
}

static std::unique_ptr&lt;ExprAST&gt; ParsePrimary() {
  switch (CurTok) {
  default:
    return LogError(&quot;unknown token when expecting an expression&quot;);
  case tok_identifier:
    return ParseIdentifierExpr();
  case tok_number:
    return ParseNumberExpr();
  case '(':
    return ParseParenExpr();
  case tok_if:
    return ParseIfExpr();
  case tok_for:
    return ParseForExpr();
  }
}
</code></pre>

<p><code>ParseIdentifierExpr</code>,<code>ParseNumberExpr</code>和<code>ParseParenExpr</code>的实现请参考: <a href="https://l0phtg.github.io/post/llvm/kaleidoscope-implementing-a-parser-and-ast/"> Implementing a Parser and AST</a>.</p>

<p><code>ParseIfExpr</code>和<code>ParseForExpr</code>的实现请参考: <a href="https://l0phtg.github.io/post/llvm/kaleidoscope-extending-the-language-control-flow/">Extending the Language Control Flow</a>.</p>

<h2 id="函数定义和申明的ast生成">函数定义和申明的AST生成</h2>

<p>请参考:<a href="https://l0phtg.github.io/post/llvm/kaleidoscope-implementing-a-parser-and-ast/"> Implementing a Parser and AST</a></p>

<h1 id="codegen-产生llvm-ir">Codegen(产生LLVM IR)</h1>

<p><img src="/docs-pic/llvm/Codegen.png" alt="" /></p>

<h2 id="四个基本表达式的codegen">四个基本表达式的codegen</h2>

<p>请参考: <a href="https://l0phtg.github.io/post/llvm/kaleidoscope-code-generation-to-llvm-ir/">code generation to llvm ir</a></p>

<h2 id="if-then-else">if/then/else</h2>

<h3 id="kaleidoscpe-if-then-else">Kaleidoscpe: if/then/else</h3>

<pre><code class="language-c">extern foo();
extern bar();
def baz(x) if x then foo() else bar();  // 如果 x != 0, then foo, else bar;
</code></pre>

<h3 id="未经优化的llvm-ir">未经优化的LLVM IR</h3>

<p>根据我们上面编写的Kaleidoscope的代码, 可以生成下面的LLVM IR.</p>

<pre><code class="language-LLVM">declare double @foo()

declare double @bar()

define double @baz(double %x) {
entry:
  %ifcond = fcmp one double %x, 0.000000e+00
  br i1 %ifcond, label %then, label %else

then:       ; preds = %entry
  %calltmp = call double @foo()
  br label %ifcont

else:       ; preds = %entry
  %calltmp1 = call double @bar()
  br label %ifcont

ifcont:     ; preds = %else, %then
  %iftmp = phi double [ %calltmp, %then ], [ %calltmp1, %else ] ; 返回值
  ret double %iftmp
}
</code></pre>

<h4 id="ir解析">IR解析</h4>

<table>
<thead>
<tr>
<th>IR指令</th>
<th>例子</th>
<th>作用</th>
</tr>
</thead>

<tbody>
<tr>
<td>$\bold{fcmp}$</td>
<td>$\color{red}{fcmp}$ $one$ $double$ ${x}$,   $0.0e+00$</td>
<td>比较指令, 相等则返回 0, 不相等返回 1</td>
</tr>

<tr>
<td>$\bold{call}$</td>
<td>$\color{red}{call}$    $double$ $@ foo()$</td>
<td>调用函数</td>
</tr>

<tr>
<td>$\bold{br}$</td>
<td>$\color{red}{br}$       ${label }$  ${\%ifcont}$</td>
<td>直接跳转</td>
</tr>

<tr>
<td>$\bold{br}$</td>
<td>$\color{red}{br}$       $i1$  $\%ifcond$,  $label$  $\%then$,   $label$   $\%else$</td>
<td>条件跳转</td>
</tr>

<tr>
<td>$\bold{phi}$</td>
<td>$\color{red}{phi}$     ${double [\% calltmp, \%then] }$, ${[\%calltmp1, \%else]}$</td>
<td>调用${phi}$ 函数</td>
</tr>

<tr>
<td>$\bold{ret}$</td>
<td>$\color{red}{ret}$     $double$ $\% 0$</td>
<td>函数返回</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr>
<th>Label</th>
<th>means</th>
</tr>
</thead>

<tbody>
<tr>
<td>$\bold{entry}$</td>
<td>函数入口</td>
</tr>

<tr>
<td>$\bold{then}$</td>
<td>条件分支then</td>
</tr>

<tr>
<td>$\bold{else}$</td>
<td>条件分支else</td>
</tr>

<tr>
<td>$\bold{ifcont}$</td>
<td>结束条件分支</td>
</tr>
</tbody>
</table>

<h3 id="if-then-else-s-cfg">if/then/else&rsquo;s CFG</h3>

<p>使用<code>opt -analyze -view-cfg if.bc</code>生成的CFG.</p>

<p><img src="/docs-pic/llvm/if.png" alt="" /></p>

<h4 id="if-then-else-s-dominator-判断哪里需要插入phi函数">if/then/else&rsquo;s dominator (判断哪里需要插入phi函数)</h4>

<p>这里只是对插入$\phi$函数时机的一个分析. (不想了解的壳跳过).</p>

<p>根据我前面翻译的文章: <a href="https://l0phtg.github.io/post/dominatorgraph-theory/">Dominator</a>来分析我们<code>if/then/else</code>的控制流.</p>

<p>我们将:  <code>entry</code> 视为节点 $\bold{1}$。    <code>then</code>视为节点 $\bold{2}$。</p>

<p>​         <code>else</code> 视为节点 $\bold{3}$。      <code>ifcont</code>视为节点 $\bold{4}$。</p>

<table>
<thead>
<tr>
<th>$\bold{1}$</th>
<th>$\color{black}{dom}$</th>
<th>$\color{Gray}{1}$</th>
<th>$\color{Red}{2}$</th>
<th>$\color{Red}{3}$</th>
<th>4</th>
</tr>
</thead>

<tbody>
<tr>
<td>$\bold{2}$</td>
<td>$\color{black}{dom}$</td>
<td></td>
<td>$\color{Gray}{2}$</td>
<td></td>
<td></td>
</tr>

<tr>
<td>$\bold{3}$</td>
<td>$\color{black}{dom}$</td>
<td></td>
<td></td>
<td>$\color{Gray}{3}$</td>
<td></td>
</tr>

<tr>
<td>$\bold{4}$</td>
<td>$\color{black}{dom}$</td>
<td></td>
<td></td>
<td></td>
<td>$\color{Gray}{4}$</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr>
<th>节点</th>
<th>支配分析</th>
</tr>
</thead>

<tbody>
<tr>
<td>$\bold{1}$</td>
<td>支配: 1, 2, 3, 4.    严格支配: 2, 3, 4.     直接支配: 2, 3.    支配边界: set().</td>
</tr>

<tr>
<td>$\bold{2}$</td>
<td>支配: 2.                 严格支配: 无.           直接支配: 无.       支配边界: set(4).</td>
</tr>

<tr>
<td>$\bold{3}$</td>
<td>支配: 3.                 严格支配: 无.           直接支配: 无.       支配边界: set(4).</td>
</tr>

<tr>
<td>$\bold{4}$</td>
<td>支配: 4.                 严格支配: 无.           直接支配: 无.       支配边界: set().</td>
</tr>
</tbody>
</table>

<p>根据<a href="https://l0phtg.github.io/post/llvm/static-single-assignment/">SSA</a>理论, 我们可以在 $\bold{4}$ 节点处插入 $\bold{\phi}$ 函数.</p>

<h3 id="builder创建ir指令">Builder创建IR指令</h3>

<p>用Builder来产生每条指令的IR.</p>

<p>下面是一些<code>if/then/else</code>会涉及到的<code>Builder创建指令的操作</code>。</p>

<h4 id="创建cmp指令">创建cmp指令</h4>

<pre><code class="language-c++">CondV = Builder.CreateFCmpONE(
      CondV, ConstantFP::get(TheContext, APFloat(0.0)), &quot;ifcond&quot;);

</code></pre>

<h4 id="创建条件br指令">创建条件br指令</h4>

<pre><code class="language-c++">Builder.CreateCondBr(CondV, ThenBB, ElseBB);
</code></pre>

<h4 id="创建直接br指令">创建直接br指令</h4>

<pre><code class="language-c++">Builder.CreateBr(MergeBB);
</code></pre>

<h4 id="创建phi指令">创建phi指令</h4>

<pre><code class="language-c++">  PHINode *PN =
    Builder.CreatePHI(Type::getDoubleTy(TheContext), 2, &quot;iftmp&quot;);

  PN-&gt;addIncoming(ThenV, ThenBB);
  PN-&gt;addIncoming(ElseV, ElseBB);
  return PN;
</code></pre>

<h4 id="创建block">创建Block</h4>

<ol>
<li>构造block时直接在&rdquo;TheFunction&rdquo;后面添加该block.</li>
</ol>

<pre><code class="language-c++">BasicBlock *ThenBB =
    BasicBlock::Create(TheContext, &quot;then&quot;, TheFunction);
</code></pre>

<ol>
<li>单纯创建Block, 当未添加到函数中.</li>
</ol>

<pre><code class="language-c++">   BasicBlock *ElseBB = BasicBlock::Create(TheContext, &quot;else&quot;);
</code></pre>

<h4 id="irbuilder中插入block">IRBuilder中插入Block</h4>

<p>控制流的独特性之处在于,  它有自己的内部的作用域(block). 所以我们在编写codegen代码时, 会调用内部block的codegen. 而不会直接去处理它.(内部block的codegen是它自己处理的, 不归我们的 ifExpr.Codegen管)</p>

<p>所以我们会这样做:</p>

<pre><code class="language-c++">Builder.SetInsertPoint(ThenBB);          // 将builder此时的插入点设置为ThenBB.
Value *ThenV = Then-&gt;codegen();          // 调用 then block的codegen
</code></pre>

<h4 id="将未添加的block添加到函数中">将未添加的Block添加到函数中</h4>

<p>在&rdquo;TheFunction&rdquo;后面添加&rdquo;merge block&rdquo;, 因为在我们创建时, 只是单纯的创建的block, 还未添加到函数中.</p>

<pre><code class="language-c++">  TheFunction-&gt;getBasicBlockList().push_back(MergeBB); // TheFunction中添加Block
  Builder.SetInsertPoint(MergeBB); // IRBuilder中插入BB
</code></pre>

<h3 id="builder流程图">Builder流程图</h3>

<p>生成if/then/else 的IR可以分为四个部分生成:</p>

<ul>
<li>cond

<ol>
<li>创建cmp IR. 目的是根据条件判断返回bool值.</li>
<li>创建<strong>条件</strong>跳转IR. 目的是根据返回的bool值做分支跳转.</li>
</ol></li>
<li>then

<ol>
<li>then.codegen(). 目的是进行then block的codegen.</li>
<li>创建<strong>直接</strong>跳转IR.目的是跳转到ifcond处.</li>
</ol></li>
<li>else

<ol>
<li>else.codegen(). 目的是进行else block的codegen.</li>
<li>创建<strong>直接跳转</strong>IR,目的是跳转到ifcond处.</li>
</ol></li>
<li>ifcond(分支合并后):

<ol>
<li>创建phi函数调用IR. 目的是判断我们是从哪个分支跳转来的.</li>
</ol></li>
</ul>

<p><strong>注意</strong>, 这里不会涉及<code>ret</code>指令的<strong>codegen</strong> ,我们在<code>ifExprAST</code>中最后做的仅仅是将$\bold{\phi}$函数的返回值返回.  <code>ret</code>指令的<strong>codegen</strong>应该在<code>函数</code>的<strong>codegen</strong>时做.</p>

<p>(在上文例子中, <code>ret</code>指令的<strong>codegen</strong> 是<strong>baz</strong>函数生成的)</p>

<div class="mermaid">
graph TD
    Start("If Codegen")
    builderCreateCmp["Builder.CreateCmpOne"]
    builderCreateCond["Builder.CreateCondBr"]
    Start --> builderCreateCmp
    builderCreateCmp --> builderCreateCond
    
    subgraph Then
        builderSetInsertThenBB["Builder.SetInsertPoint(ThenBB);"]
        ThenCodegen["Then->codegen();"]
        builderCreateBr1["Builder.CreateBr"]
        builderSetInsertThenBB --> ThenCodegen
        ThenCodegen --> builderCreateBr1
    end
    
    builderCreateCond --> builderSetInsertThenBB
    
    subgraph Else
        builderSetInsertElseBB["Builder.SetInsertPoint(ElseBB);"]
        ElseCodegen["Else->codegen();"]
        builderCreateBr2["Builder.CreateBr"]
        builderSetInsertElseBB --> ElseCodegen
        ElseCodegen --> builderCreateBr2
    end
    
    builderCreateBr1 --> builderSetInsertElseBB
    
    subgraph Merge
        builderSetInsertIfcontBB["Builder.SetInsertPoint(MergeBB);"]
        builderCreatePHI["Builder.CreatePHI"]
        builderSetInsertIfcontBB --> builderCreatePHI
    end
    
    builderCreateBr2 --> builderSetInsertIfcontBB
    
    builderCreatePHI --> End("End Codegen")
    
    style builderSetInsertThenBB fill:#ffcc66
    style builderSetInsertElseBB fill:#ffcc66
    style builderSetInsertIfcontBB fill:#ffcc66
    
    style ThenCodegen fill:#ff66cc
    style ElseCodegen fill:#ff66cc
    
    style Start fill:#ff9966
    style End fill:#ff9966
</div>

<h2 id="loop">Loop</h2>

<h3 id="kaleidoscope-for">Kaleidoscope: for</h3>

<pre><code class="language-c">extern putchard(char);
def printstar(n)
  for i = 1, i &lt; n, 1.0 in
    putchard(42);  # ascii 42 = '*'

# print 100 '*' characters
printstar(100);
</code></pre>

<h3 id="未经优化的llvm-ir-1">未经优化的LLVM IR</h3>

<pre><code class="language-LLVM">declare double @putchard(double)

define double @printstar(double %n) {
entry:
  ; initial value = 1.0 (inlined into phi)
  br label %loop

loop:       ; preds = %loop, %entry
  %i = phi double [ 1.000000e+00, %entry ], [ %nextvar, %loop ]
  ; body
  %calltmp = call double @putchard(double 4.200000e+01)
  ; increment
  %nextvar = fadd double %i, 1.000000e+00

  ; termination test
  %cmptmp = fcmp ult double %i, %n
  %booltmp = uitofp i1 %cmptmp to double
  %loopcond = fcmp one double %booltmp, 0.000000e+00
  br i1 %loopcond, label %loop, label %afterloop

afterloop:      ; preds = %loop
  ; loop always returns 0.0
  ret double 0.000000e+00
}
</code></pre>

<p>有三个<code>Label</code>, 意味者三个<code>BasicBlock</code>: <strong>entry</strong>,  <strong>loop</strong>,  <strong>afterloop</strong>.</p>

<p>有四个主要的<code>Expression</code>: <strong>Start</strong>, <strong>Cond</strong>, <strong>Body</strong>, <strong>Increment</strong> .  当然还有<strong>afterloop</strong>, 它总是<code>ret 0.0</code>.</p>

<h4 id="ir解析-1">IR解析</h4>

<p>与<code>if/then/else</code>的<strong>IR</strong>指令相比较, 发现多了一条$\bold{uitofp}$指令.</p>

<table>
<thead>
<tr>
<th>IR指令</th>
<th>例子</th>
<th>作用</th>
</tr>
</thead>

<tbody>
<tr>
<td>$\bold{fcmp}$</td>
<td>$\color{red}{fcmp}$ $one$ $double$ ${\%booltmp}$,   $0.0e+00$</td>
<td>比较指令, 相等则返回 0, 不相等返回 1</td>
</tr>

<tr>
<td>$\bold{call}$</td>
<td>$\color{red}{call}$    $double$ $@ putchard(double$   $ 4.2000e+01)$</td>
<td>调用函数</td>
</tr>

<tr>
<td>$\bold{br}$</td>
<td>$\color{red}{br}$       ${label }$  ${\%loop}$</td>
<td>直接跳转</td>
</tr>

<tr>
<td>$\bold{br}$</td>
<td>$\color{red}{br}$       $i1$  $\%loopcond$  $label$  $\%loop$,  $label$  $\%afterloop$</td>
<td>条件跳转</td>
</tr>

<tr>
<td>$\bold{phi}$</td>
<td>$\color{red}{phi}$     ${double [1.0e+0, \%entry] }$, ${[\%nextvar, \%loop]}$</td>
<td>调用${phi}$ 函数</td>
</tr>

<tr>
<td>$\bold{uitofp}$</td>
<td>$\color{red}{uitofp}$ $i1$    $\%cmptmp$   $to$   $double$</td>
<td>将bool(<sup>1</sup>&frasl;<sub>0</sub>)转换为double(1.0/0.0)</td>
</tr>

<tr>
<td>$\bold{ret}$</td>
<td>$\color{red}{ret}$     $double$ $\% 0$</td>
<td>函数返回</td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr>
<th>Label</th>
<th>means</th>
</tr>
</thead>

<tbody>
<tr>
<td>$\bold{entry}$</td>
<td>函数入口</td>
</tr>

<tr>
<td>$\bold{loop}$</td>
<td>loop循环入口</td>
</tr>

<tr>
<td>$\bold{afterloop}$</td>
<td>loop循环结束</td>
</tr>
</tbody>
</table>

<h3 id="for-s-cfg">for&rsquo;s CFG</h3>

<p>使用<code>opt -analyze -view-cfg loop.bc</code>生成的CFG.</p>

<p><img src="/docs-pic/llvm/loop.png" alt="loop" /></p>

<h3 id="builder流程图-1">Builder流程图</h3>

<div class="mermaid">
graph TB

    Start("Loop Codegen") --> StartCodegen["Start->codegen();"]
    StartCodegen --> builderCreateBr["Builder.CreateBr"]
    subgraph Loop
        builderSetInsertLoopBB["Builder.SetInsertPoint(LoopBB)"]    
        builderCreatePHI["Builder.CreatePHI"]
        BodyCodegen["Body->codegen();"]

        builderSetInsertLoopBB --> builderCreatePHI
        builderCreatePHI --> BodyCodegen
        BodyCodegen --> ifStep{"Step != NULL"}
        ifStep --Y--> StepCodegen["Step->codegen();"]
        ifStep --N--> SetStep["Set Step to 1.0"]
        StepCodegen --> builderCreateFAdd["Builder.CreateFAdd"]
        SetStep --> builderCreateFAdd

        builderCreateFAdd --> EndCodegen["End->codegen();"] 
        EndCodegen --> builderCreateFCmp["Builder.CreateFCmpOne"] 
        builderCreateFCmp --> builderCreateCondBr["Builder.CreateCondBr"]
    end 

    builderCreateBr --> builderSetInsertLoopBB

    subgraph afterloop
        builderSetInsertAfterBB["Builder.SetInsertPoint(AfterBB)"]
    end 
    
    builderCreateCondBr --> builderSetInsertAfterBB
    
    builderSetInsertAfterBB --> End["End Codegen"]


    style builderSetInsertLoopBB fill:#ffcc66
    style builderSetInsertAfterBB fill:#ffcc66

    
    style StartCodegen fill:#ff66cc
    style BodyCodegen fill:#ff66cc
    style StepCodegen fill:#ff66cc
    style EndCodegen fill:#ff66cc
    
    style Start fill:#ff9966
    style End fill:#ff9966

</div>

<h1 id="jit和优化">JIT和优化</h1>

<p>参考: <a href="https://l0phtg.github.io/post/llvm/kaleidoscope-adding-jit-and-optimizer-support/">Adding JIT and Optimizer Support</a></p>

<div class="mermaid">
graph TB

    subgraph call
        funcall("foo(1);")
    end

    subgraph expr
        nodeExpr("1+2;")
    end
    
    jitAddModule["JIT中 添加此Module"]
    jitRemoveModule["JIT中 删除此Module"]
    
    anoCodegen["执行 匿名函数Codegen"]
    AnonymousCall["匿名函数包装"]
    optimizeFunc["执行 Pass优化"]
    nodeExpr --> AnonymousCall
    funcall --> AnonymousCall
    AnonymousCall --> anoCodegen
    anoCodegen --> jitAddModule
    jitAddModule --> optimizeFunc
    optimizeFunc --> exec["jit运行此表达式, 并计算值"]
    exec --> jitRemoveModule
    
    subgraph func definition
        nodeFoo("def foo(x) x+1;")
        funcCodegen["执行 函数定义Codegen"]
        nodeFoo --> funcCodegen
    end
    
    funcCodegen --> jitAddFuncModule["jit中 添加此Module"]
    jitAddFuncModule --> initPassManager["执行 pass优化"]


    subgraph extern
        nodeExtern("extern sin(x);")
        protoCodegen["执行 函数申明Codegen"]
        nodeExtern --> protoCodegen
    end
    
    style jitAddModule fill:#f9f
    style jitRemoveModule fill:#f9f
    style jitAddFuncModule fill:#f9f
    
    style optimizeFunc fill:#ccff66
    style initPassManager fill:#ccff66
    
    style exec fill:#ff3300
    
</div>

<h1 id="driver">Driver</h1>

<pre><code class="language-c++">/// top ::= definition | external | expression | ';'
static void MainLoop() {
  while (true) {
    fprintf(stderr, &quot;ready&gt; &quot;);
    switch (CurTok) {
    case tok_eof:
      return;
    case ';': // ignore top-level semicolons.
      getNextToken();
      break;
    case tok_def:
      HandleDefinition();
      break;
    case tok_extern:
      HandleExtern();
      break;
    default:
      HandleTopLevelExpression();
      break;
    }
  }
}
</code></pre>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">L0phTg</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2019-04-15</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content">原创文章，如需转载请注明文章作者和出处。谢谢！</span>
  </p>
</div>

    
    

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/llvm/">llvm</a>
          
          <a href="/tags/kaleidoscope/">Kaleidoscope</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/handwriting/%E4%B9%A0%E5%AD%97%E5%85%A5%E9%97%A8/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">习字 入门</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/life/%E4%B9%A6%E7%AD%BE%E6%95%B4%E7%90%86/">
            <span class="next-text nav-default">书签整理</span>
            <span class="prev-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
    
  </article>
        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="l0phtg:l0phtg@163.com" rel="me noopener" class="iconfont icon-email"
        title="email" target="_blank">
      </a>
      <a href="https://google.com" rel="me noopener" class="iconfont icon-google"
        title="google" target="_blank">
      </a>
      <a href="https://github.com/l0phtg" rel="me noopener" class="iconfont icon-github"
        title="github" target="_blank">
      </a>
  <a href="https://l0phtg.github.io/index.xml" rel="noopener" type="application/rss+xml" class="iconfont icon-rss"
    title="rss" target="_blank">
  </a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span><span class="author">l0phtg</span></span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>
<script type="text/javascript" src="/dist/jane.min.js?v=2.7.0"></script>
  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML'></script>





<script src="/js/highlight.pack.js"></script>

<script src="/js/mermaid.min.js"></script>


<script>hljs.initHighlightingOnLoad();</script>
<script> mermaid.initialize({ startOnLoad: true });</script>

</body>
</html>
