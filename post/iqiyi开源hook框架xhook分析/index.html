<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Iqiyi开源hook框架XHook分析 - L0phTg&#39;s Blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="L0phTg" />
  <meta name="description" content="Got Hook 可以使用dlsym得到目标函数的地址, 然后遍历got表进行Hook.
但是有时候我们不能通过dlsym得到函数地址. 这时我们需要怎么办呢? iqiyi的xhook很好的解决了这个问题, (可以参考linker的实现, 有问题, 看源码.
通过找到目标函数地址存放在got表中位置, 只要找到了目标symbol在got表中的offset, 想要修改或者得到目标函数的实际地址就轻松多了.
symbol -&amp;gt; symid -&amp;gt; 在got表中的offset -&amp;gt; 目标函数实际地址

" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.49-DEV" />


<link rel="canonical" href="https://l0phtg.github.io/post/iqiyi%E5%BC%80%E6%BA%90hook%E6%A1%86%E6%9E%B6xhook%E5%88%86%E6%9E%90/" />



<link rel="icon" href="/favicon.ico" />










<link href="/dist/jane.min.css?v=2.7.0" rel="stylesheet">




<meta property="og:title" content="Iqiyi开源hook框架XHook分析" />
<meta property="og:description" content="Got Hook 可以使用dlsym得到目标函数的地址, 然后遍历got表进行Hook.

但是有时候我们不能通过dlsym得到函数地址. 这时我们需要怎么办呢? iqiyi的xhook很好的解决了这个问题, (可以参考linker的实现, 有问题, 看源码.

通过找到目标函数地址存放在got表中位置, 只要找到了目标symbol在got表中的offset, 想要修改或者得到目标函数的实际地址就轻松多了.

symbol -&gt; symid -&gt; 在got表中的offset  -&gt; 目标函数实际地址

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://l0phtg.github.io/post/iqiyi%E5%BC%80%E6%BA%90hook%E6%A1%86%E6%9E%B6xhook%E5%88%86%E6%9E%90/" /><meta property="article:published_time" content="2018-09-19T02:19:05&#43;08:00"/>
<meta property="article:modified_time" content="2018-09-19T02:19:05&#43;08:00"/>
<meta itemprop="name" content="Iqiyi开源hook框架XHook分析">
<meta itemprop="description" content="Got Hook 可以使用dlsym得到目标函数的地址, 然后遍历got表进行Hook.

但是有时候我们不能通过dlsym得到函数地址. 这时我们需要怎么办呢? iqiyi的xhook很好的解决了这个问题, (可以参考linker的实现, 有问题, 看源码.

通过找到目标函数地址存放在got表中位置, 只要找到了目标symbol在got表中的offset, 想要修改或者得到目标函数的实际地址就轻松多了.

symbol -&gt; symid -&gt; 在got表中的offset  -&gt; 目标函数实际地址

">


<meta itemprop="datePublished" content="2018-09-19T02:19:05&#43;08:00" />
<meta itemprop="dateModified" content="2018-09-19T02:19:05&#43;08:00" />
<meta itemprop="wordCount" content="1466">



<meta itemprop="keywords" content="hook," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Iqiyi开源hook框架XHook分析"/>
<meta name="twitter:description" content="Got Hook 可以使用dlsym得到目标函数的地址, 然后遍历got表进行Hook.

但是有时候我们不能通过dlsym得到函数地址. 这时我们需要怎么办呢? iqiyi的xhook很好的解决了这个问题, (可以参考linker的实现, 有问题, 看源码.

通过找到目标函数地址存放在got表中位置, 只要找到了目标symbol在got表中的offset, 想要修改或者得到目标函数的实际地址就轻松多了.

symbol -&gt; symid -&gt; 在got表中的offset  -&gt; 目标函数实际地址

"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">L0phTg&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/about/">About</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://gohugo.io" rel="noopener" target="_blank">
              external-link
              <i class="iconfont icon-new-window"></i>
            </a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      L0phTg's Blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/">Home</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/post/">Archives</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/tags/">Tags</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/categories/">Categories</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://l0phtg.github.io/about/">About</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://gohugo.io" rel="noopener" target="_blank">
              external-link
            <i class="iconfont icon-new-window"></i>
            </a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Iqiyi开源hook框架XHook分析</h1>
      
      <div class="post-meta">
        <span class="post-time"> 2018-09-19 </span>
        <div class="post-category">
            <a href="https://l0phtg.github.io/categories/hook/"> hook </a>
            
          </div>
        

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#阅读readme">阅读Readme</a></li>
<li><a href="#分析">分析</a>
<ul>
<li><a href="#xhook-register-hook函数注册">xhook_register Hook函数注册</a>
<ul>
<li><a href="#函数申明">函数申明</a></li>
<li><a href="#函数实现分析">函数实现分析</a>
<ul>
<li><a href="#xh-core-register">xh_core_register</a></li>
<li><a href="#xh-elf-init">xh_elf_init:</a></li>
</ul></li>
</ul></li>
<li><a href="#xh-refresh">xh_refresh</a>
<ul>
<li><a href="#xh-elf-hook">xh_elf_hook</a>
<ul>
<li><a href="#xh-elf-find-symidx-by-name">xh_elf_find_symidx_by_name</a></li>
<li><a href="#xh-elf-find-and-replace-func">xh_elf_find_and_replace_func</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>Got Hook 可以使用dlsym得到目标函数的地址, 然后遍历got表进行Hook.</p>

<p>但是有时候我们不能通过dlsym得到函数地址. 这时我们需要怎么办呢? iqiyi的xhook很好的解决了这个问题, (可以参考linker的实现, <strong>有问题, 看源码</strong>.</p>

<p>通过找到目标函数地址存放在got表中位置, 只要找到了目标symbol在got表中的offset, 想要修改或者得到目标函数的实际地址就轻松多了.</p>

<p>symbol -&gt; symid -&gt; 在got表中的offset  -&gt; 目标函数实际地址</p>

<p></p>

<h1 id="阅读readme">阅读Readme</h1>

<p><a href="https://github.com/iqiyi/xHook/blob/master/README.zh-CN.md">https://github.com/iqiyi/xHook/blob/master/README.zh-CN.md</a>
<a href="https://github.com/iqiyi/xHook/blob/master/docs/overview/android_plt_hook_overview.zh-CN.md">https://github.com/iqiyi/xHook/blob/master/docs/overview/android_plt_hook_overview.zh-CN.md</a></p>

<pre><code>//监测内存泄露
xhook_register(&quot;.*\\.so$&quot;, &quot;malloc&quot;,  my_malloc,  NULL);
xhook_register(&quot;.*\\.so$&quot;, &quot;calloc&quot;,  my_calloc,  NULL);
xhook_register(&quot;.*\\.so$&quot;, &quot;realloc&quot;, my_realloc, NULL);
xhook_register(&quot;.*\\.so$&quot;, &quot;free&quot;,    my_free,    NULL);

//监控 sockets 生命周期
xhook_register(&quot;.*\\.so$&quot;, &quot;getaddrinfo&quot;, my_getaddrinfo, NULL);
xhook_register(&quot;.*\\.so$&quot;, &quot;socket&quot;,      my_socket,      NULL);
xhook_register(&quot;.*\\.so$&quot;, &quot;setsockopt&quot;   my_setsockopt,  NULL);
xhook_register(&quot;.*\\.so$&quot;, &quot;bind&quot;,        my_bind,        NULL);
xhook_register(&quot;.*\\.so$&quot;, &quot;listen&quot;,      my_listen,      NULL);
xhook_register(&quot;.*\\.so$&quot;, &quot;connect&quot;,     my_connect,     NULL);
xhook_register(&quot;.*\\.so$&quot;, &quot;shutdown&quot;,    my_shutdown,    NULL);
xhook_register(&quot;.*\\.so$&quot;, &quot;close&quot;,       my_close,       NULL);

//过滤出和保存部分安卓 log 到本地文件
xhook_register(&quot;.*\\.so$&quot;, &quot;__android_log_write&quot;,  my_log_write,  NULL);
xhook_register(&quot;.*\\.so$&quot;, &quot;__android_log_print&quot;,  my_log_print,  NULL);
xhook_register(&quot;.*\\.so$&quot;, &quot;__android_log_vprint&quot;, my_log_vprint, NULL);
xhook_register(&quot;.*\\.so$&quot;, &quot;__android_log_assert&quot;, my_log_assert, NULL);

//追踪某些调用 (忽略 linker 和 linker64)
xhook_register(&quot;^/system/.*$&quot;, &quot;mmap&quot;,   my_mmap,   NULL);
xhook_register(&quot;^/vendor/.*$&quot;, &quot;munmap&quot;, my_munmap, NULL);
xhook_ignore  (&quot;.*/linker$&quot;,   &quot;mmap&quot;);
xhook_ignore  (&quot;.*/linker$&quot;,   &quot;munmap&quot;);
xhook_ignore  (&quot;.*/linker64$&quot;, &quot;mmap&quot;);
xhook_ignore  (&quot;.*/linker64$&quot;, &quot;munmap&quot;);

//防御某些注入攻击
xhook_register(&quot;.*com\\.hacker.*\\.so$&quot;, &quot;malloc&quot;,  my_malloc_always_return_NULL, NULL);
xhook_register(&quot;.*/libhacker\\.so$&quot;,     &quot;connect&quot;, my_connect_with_recorder,     NULL);

//修复某些系统 bug
xhook_register(&quot;.*some_vendor.*/libvictim\\.so$&quot;, &quot;bad_func&quot;, my_nice_func, NULL);

//忽略 libwebviewchromium.so 的所有 hook 信息
xhook_ignore(&quot;.*/libwebviewchromium.so$&quot;, NULL);

//现在执行 hook!
xhook_refresh(1);
</code></pre>

<p>发现重点为下面几个函数:</p>

<ol>
<li>xhook_register</li>
<li>xhook_ignore</li>
<li>xhook_refresh</li>
</ol>

<p>接下来依次分析</p>

<h1 id="分析">分析</h1>

<h2 id="xhook-register-hook函数注册">xhook_register Hook函数注册</h2>

<h3 id="函数申明">函数申明</h3>

<pre><code>int xhook_register(const char *pathname_regex_str, const char *symbol,
                   void *new_func, void **old_func) XHOOK_EXPORT;
</code></pre>

<h3 id="函数实现分析">函数实现分析</h3>

<pre><code>int xhook_register(const char *pathname_regex_str, const char *symbol,
                   void *new_func, void **old_func)
{
    return xh_core_register(pathname_regex_str, symbol, new_func, old_func);
}

</code></pre>

<h4 id="xh-core-register">xh_core_register</h4>

<pre><code>int xh_core_register(const char *pathname_regex_str, const char *symbol,
                     void *new_func, void **old_func)
{
    xh_core_hook_info_t *hi;
    regex_t              regex;

    if(NULL == pathname_regex_str || NULL == symbol || NULL == new_func) return XH_ERRNO_INVAL;

    if(xh_core_inited)
    {
        XH_LOG_ERROR(&quot;do not register hook after refresh(): %s, %s&quot;, pathname_regex_str, symbol);
        return XH_ERRNO_INVAL;
    }

    if(0 != regcomp(&amp;regex, pathname_regex_str, REG_NOSUB)) return XH_ERRNO_INVAL;

    if(NULL == (hi = malloc(sizeof(xh_core_hook_info_t)))) return XH_ERRNO_NOMEM;
    if(NULL == (hi-&gt;symbol = strdup(symbol)))
    {
        free(hi);
        return XH_ERRNO_NOMEM;
    }
#if XH_CORE_DEBUG
    if(NULL == (hi-&gt;pathname_regex_str = strdup(pathname_regex_str)))
    {
        free(hi-&gt;symbol);
        free(hi);
        return XH_ERRNO_NOMEM;
    }
#endif
    hi-&gt;pathname_regex = regex;
    hi-&gt;new_func = new_func;
    hi-&gt;old_func = old_func;
    
    pthread_mutex_lock(&amp;xh_core_mutex);
    TAILQ_INSERT_TAIL(&amp;xh_core_hook_info, hi, link); // 核心
    pthread_mutex_unlock(&amp;xh_core_mutex);

    return 0;
}
</code></pre>

<h4 id="xh-elf-init">xh_elf_init:</h4>

<ol>
<li>设置 load_bias, elf_header, Program header地址.</li>
<li>找到第一个PT_LOAD段</li>
<li>找到dynamic_header. 之后解析dynamic segment, 找到strtab, symtab, rel.plt, .rel,等</li>
</ol>

<pre><code>
int xh_elf_init(xh_elf_t *self, uintptr_t base_addr, const char *pathname)
{
    if(0 == base_addr || NULL == pathname) return XH_ERRNO_INVAL;

    //always reset
    memset(self, 0, sizeof(xh_elf_t));
    
    self-&gt;pathname = pathname;
    self-&gt;base_addr = (ElfW(Addr))base_addr;
    self-&gt;ehdr = (ElfW(Ehdr) *)base_addr;
    self-&gt;phdr = (ElfW(Phdr) *)(base_addr + self-&gt;ehdr-&gt;e_phoff); //segmentation fault sometimes

    //find the first load-segment with offset 0
    ElfW(Phdr) *phdr0 = xh_elf_get_first_segment_by_type_offset(self, PT_LOAD, 0);
    if(NULL == phdr0)
    {
        XH_LOG_ERROR(&quot;Can NOT found the first load segment. %s&quot;, pathname);
        return XH_ERRNO_FORMAT;
    }

#if XH_ELF_DEBUG
    if(0 != phdr0-&gt;p_vaddr)
        XH_LOG_DEBUG(&quot;first load-segment vaddr NOT 0 (vaddr: %p). %s&quot;,
                     (void *)(phdr0-&gt;p_vaddr), pathname);
#endif

    //save load bias addr
    if(self-&gt;base_addr &lt; phdr0-&gt;p_vaddr) return XH_ERRNO_FORMAT;
    self-&gt;bias_addr = self-&gt;base_addr - phdr0-&gt;p_vaddr;
    
    //find dynamic-segment
    ElfW(Phdr) *dhdr = xh_elf_get_first_segment_by_type(self, PT_DYNAMIC);
    if(NULL == dhdr)
    {
        XH_LOG_ERROR(&quot;Can NOT found dynamic segment. %s&quot;, pathname);
        return XH_ERRNO_FORMAT;
    }

    //parse dynamic-segment
    self-&gt;dyn          = (ElfW(Dyn) *)(self-&gt;bias_addr + dhdr-&gt;p_vaddr);
    self-&gt;dyn_sz       = dhdr-&gt;p_memsz;
    ElfW(Dyn) *dyn     = self-&gt;dyn;
    ElfW(Dyn) *dyn_end = self-&gt;dyn + (self-&gt;dyn_sz / sizeof(ElfW(Dyn)));
    uint32_t  *raw;
    for(; dyn &lt; dyn_end; dyn++)
    {
        switch(dyn-&gt;d_tag) //segmentation fault sometimes
        {
        case DT_NULL:
            //the end of the dynamic-section
            dyn = dyn_end;
            break;
        case DT_STRTAB:
            {
                self-&gt;strtab = (const char *)(self-&gt;bias_addr + dyn-&gt;d_un.d_ptr);
                if((ElfW(Addr))(self-&gt;strtab) &lt; self-&gt;base_addr) return XH_ERRNO_FORMAT;
                break;
            }
        case DT_SYMTAB:
            {
                self-&gt;symtab = (ElfW(Sym) *)(self-&gt;bias_addr + dyn-&gt;d_un.d_ptr);
                if((ElfW(Addr))(self-&gt;symtab) &lt; self-&gt;base_addr) return XH_ERRNO_FORMAT;
                break;
            }
        case DT_PLTREL:
            //use rel or rela?
            self-&gt;is_use_rela = (dyn-&gt;d_un.d_val == DT_RELA ? 1 : 0);
            break;
        case DT_JMPREL:
            {
                self-&gt;relplt = (ElfW(Addr))(self-&gt;bias_addr + dyn-&gt;d_un.d_ptr);
                if((ElfW(Addr))(self-&gt;relplt) &lt; self-&gt;base_addr) return XH_ERRNO_FORMAT;
                break;
            }
        case DT_PLTRELSZ:
            self-&gt;relplt_sz = dyn-&gt;d_un.d_val;
            break;
        case DT_REL:
        case DT_RELA:
            {
                self-&gt;reldyn = (ElfW(Addr))(self-&gt;bias_addr + dyn-&gt;d_un.d_ptr);
                if((ElfW(Addr))(self-&gt;reldyn) &lt; self-&gt;base_addr) return XH_ERRNO_FORMAT;
                break;
            }
        case DT_RELSZ:
        case DT_RELASZ:
            self-&gt;reldyn_sz = dyn-&gt;d_un.d_val;
            break;
        case DT_ANDROID_REL:
        case DT_ANDROID_RELA:
            {
                self-&gt;relandroid = (ElfW(Addr))(self-&gt;bias_addr + dyn-&gt;d_un.d_ptr);
                if((ElfW(Addr))(self-&gt;relandroid) &lt; self-&gt;base_addr) return XH_ERRNO_FORMAT;
                break;
            }
        case DT_ANDROID_RELSZ:
        case DT_ANDROID_RELASZ:
            self-&gt;relandroid_sz = dyn-&gt;d_un.d_val;
            break;
        case DT_HASH:
            {
                raw = (uint32_t *)(self-&gt;bias_addr + dyn-&gt;d_un.d_ptr);
                if((ElfW(Addr))raw &lt; self-&gt;base_addr) return XH_ERRNO_FORMAT;
                self-&gt;bucket_cnt  = raw[0];
                self-&gt;chain_cnt   = raw[1];
                self-&gt;bucket      = &amp;raw[2];
                self-&gt;chain       = &amp;(self-&gt;bucket[self-&gt;bucket_cnt]);
                break;
            }
        case DT_GNU_HASH:
            {
                raw = (uint32_t *)(self-&gt;bias_addr + dyn-&gt;d_un.d_ptr);
                if((ElfW(Addr))raw &lt; self-&gt;base_addr) return XH_ERRNO_FORMAT;
                self-&gt;bucket_cnt  = raw[0];
                self-&gt;symoffset   = raw[1];
                self-&gt;bloom_sz    = raw[2];
                self-&gt;bloom_shift = raw[3];
                self-&gt;bloom       = (ElfW(Addr) *)(&amp;raw[4]);
                self-&gt;bucket      = (uint32_t *)(&amp;(self-&gt;bloom[self-&gt;bloom_sz]));
                self-&gt;chain       = (uint32_t *)(&amp;(self-&gt;bucket[self-&gt;bucket_cnt]));
                self-&gt;is_use_gnu_hash = 1;
                break;
            }
        default:
            break;
        }
    }

    //check android rel/rela
    if(0 != self-&gt;relandroid)
    {
        const char *rel = (const char *)self-&gt;relandroid;
        if(self-&gt;relandroid_sz &lt; 4 ||
           rel[0] != 'A' ||
           rel[1] != 'P' ||
           rel[2] != 'S' ||
           rel[3] != '2')
        {
            XH_LOG_ERROR(&quot;android rel/rela format error\n&quot;);
            return XH_ERRNO_FORMAT;
        }
        
        self-&gt;relandroid += 4;
        self-&gt;relandroid_sz -= 4;
    }

    //check elf info
    if(0 != xh_elf_check(self))
    {
        XH_LOG_ERROR(&quot;elf init check failed. %s&quot;, pathname);
        return XH_ERRNO_FORMAT;
    }
    
#if XH_ELF_DEBUG
    xh_elf_dump(self);
#endif

    XH_LOG_INFO(&quot;init OK: %s (%s %s PLT:%u DYN:%u ANDROID:%u)\n&quot;, self-&gt;pathname,
                self-&gt;is_use_rela ? &quot;RELA&quot; : &quot;REL&quot;,
                self-&gt;is_use_gnu_hash ? &quot;GNU_HASH&quot; : &quot;ELF_HASH&quot;,
                self-&gt;relplt_sz, self-&gt;reldyn_sz, self-&gt;relandroid_sz);

    return 0;
}
</code></pre>

<h2 id="xh-refresh">xh_refresh</h2>

<pre><code>xh_refresh -&gt; xh_core_refresh -&gt; xh_core_init_once

                              -&gt; xh_core_refresh_impl 
   

xh_core_refresh_impl -&gt; xh_core_check_elf_header
                     -&gt; xh_core_hook             -&gt; xh_core_hook_impl
                     
                     
xh_core_hook_impl    -&gt; xh_elf_init
                     -&gt; xh_elf_hook
</code></pre>

<h3 id="xh-elf-hook">xh_elf_hook</h3>

<ol>
<li>xh_elf_find_symidx_by_name    //find symbol index by symbol name</li>
<li>replace.</li>
</ol>

<pre><code>    //find symbol index by symbol name
    if(0 != (r = xh_elf_find_symidx_by_name(self, symbol, &amp;symidx))) return 0;
    
    //replace for .rel(a).plt
    if(0 != self-&gt;relplt)
    {
        xh_elf_plain_reloc_iterator_init(&amp;plain_iter, self-&gt;relplt, self-&gt;relplt_sz, self-&gt;is_use_rela);
        while(NULL != (rel_common = xh_elf_plain_reloc_iterator_next(&amp;plain_iter)))
        {
            if(0 != (r = xh_elf_find_and_replace_func(self,
                                                      (self-&gt;is_use_rela ? &quot;.rela.plt&quot; : &quot;.rel.plt&quot;), 1,
                                                      symbol, new_func, old_func,
                                                      symidx, rel_common, &amp;found))) return r;
            if(found) break;
        }
    }
</code></pre>

<h4 id="xh-elf-find-symidx-by-name">xh_elf_find_symidx_by_name</h4>

<p>其中: 寻找symidx, 遍历symtab,</p>

<pre><code>static int xh_elf_find_symidx_by_name(xh_elf_t *self, const char *symbol, uint32_t *symidx)
{
    if(self-&gt;is_use_gnu_hash)
        return xh_elf_gnu_hash_lookup(self, symbol, symidx);
    else
        return xh_elf_hash_lookup(self, symbol, symidx);
}
</code></pre>

<h4 id="xh-elf-find-and-replace-func">xh_elf_find_and_replace_func</h4>

<p>rel, rela表中存放这r_offset, 和symidx.</p>

<p>真正替换的流程在<strong>xh_elf_find_and_replace_func</strong>.</p>

<pre><code>static int xh_elf_find_and_replace_func(xh_elf_t *self, const char *section,
                                        int is_plt, const char *symbol,
                                        void *new_func, void **old_func,
                                        uint32_t symidx, void *rel_common,
                                        int *found)
{
    ElfW(Rela)    *rela;
    ElfW(Rel)     *rel;
    ElfW(Addr)     r_offset;
    size_t         r_info;
    size_t         r_sym;
    size_t         r_type;
    ElfW(Addr)     addr;
    int            r;

    if(NULL != found) *found = 0;
    
    if(self-&gt;is_use_rela)
    {
        rela = (ElfW(Rela) *)rel_common;
        r_info = rela-&gt;r_info;
        r_offset = rela-&gt;r_offset;
    }
    else
    {
        rel = (ElfW(Rel) *)rel_common;
        r_info = rel-&gt;r_info;
        r_offset = rel-&gt;r_offset;
    }

    //check sym
    r_sym = XH_ELF_R_SYM(r_info);
    if(r_sym != symidx) return 0;

    //check type
    r_type = XH_ELF_R_TYPE(r_info);
    if(is_plt &amp;&amp; r_type != XH_ELF_R_GENERIC_JUMP_SLOT) return 0;
    if(!is_plt &amp;&amp; (r_type != XH_ELF_R_GENERIC_GLOB_DAT &amp;&amp; r_type != XH_ELF_R_GENERIC_ABS)) return 0;

    //we found it
    XH_LOG_INFO(&quot;found %s at %s offset: %p\n&quot;, symbol, section, (void *)r_offset);
    if(NULL != found) *found = 1;

    //do replace
    addr = self-&gt;bias_addr + r_offset;
    if(addr &lt; self-&gt;base_addr) return XH_ERRNO_FORMAT;
    if(0 != (r = xh_elf_replace_function(self, symbol, addr, new_func, old_func)))
    {
        XH_LOG_ERROR(&quot;replace function failed: %s at %s\n&quot;, symbol, section);
        return r;
    }

    return 0;
}
</code></pre>
    </div>

    
    

    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://l0phtg.github.io/tags/hook/">hook</a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/inlinehook%E5%AD%A6%E4%B9%A0%E5%88%86%E6%9E%90/">
            <span class="next-text nav-default">InlineHook学习分析</span>
            <span class="prev-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>

  
  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="l0phtg:l0phtg@163.com" rel="me noopener" class="iconfont icon-email"
        title="email" target="_blank">
      </a>
      <a href="https://google.com" rel="me noopener" class="iconfont icon-google"
        title="google" target="_blank">
      </a>
      <a href="https://github.com/l0phtg" rel="me noopener" class="iconfont icon-github"
        title="github" target="_blank">
      </a>
  <a href="https://l0phtg.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml" class="iconfont icon-rss"
    title="rss" target="_blank">
  </a>
  </div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    2018
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span><span class="author">
        l0phtg
        
      </span></span>

  
  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
<script type="text/javascript" src="/dist/jane.min.js?v=2.7.0"></script>





  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  











</body>
</html>
